### 1.èƒŒæ™¯æ„ä¹‰

ç ”ç©¶èƒŒæ™¯ä¸æ„ä¹‰

çœ¼åº•å›¾åƒåˆ†æåœ¨åŒ»å­¦å½±åƒå­¦ä¸­æ‰®æ¼”ç€è‡³å…³é‡è¦çš„è§’è‰²ï¼Œå°¤å…¶æ˜¯åœ¨æ—©æœŸè¯Šæ–­å’Œç›‘æµ‹çœ¼ç§‘ç–¾ç—…æ–¹é¢ã€‚éšç€äººå£è€é¾„åŒ–çš„åŠ å‰§ï¼Œçœ¼ç§‘ç–¾ç—…çš„å‘ç—…ç‡é€å¹´ä¸Šå‡ï¼Œå°¤å…¶æ˜¯ç³–å°¿ç—…è§†ç½‘è†œç—…å˜ã€é»„æ–‘å˜æ€§ç­‰ç–¾ç—…ï¼Œç»™æ‚£è€…çš„è§†åŠ›å¥åº·å¸¦æ¥äº†ä¸¥é‡å¨èƒã€‚å› æ­¤ï¼Œå¼€å‘é«˜æ•ˆã€å‡†ç¡®çš„çœ¼åº•å›¾åƒåˆ†æç³»ç»Ÿï¼Œå°¤å…¶æ˜¯å±‚æ¬¡åˆ†å‰²æŠ€æœ¯ï¼Œæ˜¾å¾—å°¤ä¸ºé‡è¦ã€‚å±‚æ¬¡åˆ†å‰²èƒ½å¤Ÿå¸®åŠ©åŒ»ç”Ÿæ¸…æ™°åœ°è¯†åˆ«å’Œå®šä½çœ¼åº•å›¾åƒä¸­çš„å„ä¸ªç»“æ„ï¼Œè¿›è€Œæé«˜è¯Šæ–­çš„å‡†ç¡®æ€§å’Œæ•ˆç‡ã€‚

æœ¬ç ”ç©¶æ—¨åœ¨åŸºäºæ”¹è¿›çš„YOLOv11æ¨¡å‹ï¼Œæ„å»ºä¸€ä¸ªé«˜æ•ˆçš„çœ¼åº•å›¾åƒå±‚æ¬¡åˆ†å‰²ç³»ç»Ÿã€‚è¯¥ç³»ç»Ÿå°†åˆ©ç”¨oct5k_new_newæ•°æ®é›†ï¼Œè¯¥æ•°æ®é›†åŒ…å«4600å¹…çœ¼åº•å›¾åƒï¼Œæ¶µç›–äº†6ä¸ªä¸åŒçš„ç±»åˆ«ï¼ŒåŒ…æ‹¬å†…ç•Œè†œï¼ˆILMï¼‰ã€è§†ç½‘è†œè‰²ç´ ä¸Šçš®ï¼ˆRPEï¼‰ã€å¤–å±‚ï¼ˆOPLï¼‰ç­‰ã€‚è¿™äº›ç±»åˆ«çš„å‡†ç¡®åˆ†å‰²å¯¹äºç–¾ç—…çš„è¯Šæ–­å’Œæ²»ç–—æ–¹æ¡ˆçš„åˆ¶å®šè‡³å…³é‡è¦ã€‚é€šè¿‡å¯¹è¿™äº›å›¾åƒè¿›è¡Œæ·±åº¦å­¦ä¹ è®­ç»ƒï¼Œç³»ç»Ÿå°†èƒ½å¤Ÿè‡ªåŠ¨è¯†åˆ«å’Œåˆ†å‰²å‡ºçœ¼åº•å›¾åƒä¸­çš„å…³é”®ç»“æ„ï¼Œå‡è½»åŒ»ç”Ÿçš„å·¥ä½œè´Ÿæ‹…ï¼Œæé«˜è¯Šæ–­æ•ˆç‡ã€‚

æ­¤å¤–ï¼Œæ•°æ®é›†ç»è¿‡å¤šç§æ•°æ®å¢å¼ºå¤„ç†ï¼Œæå¤§åœ°ä¸°å¯Œäº†è®­ç»ƒæ ·æœ¬çš„å¤šæ ·æ€§ï¼Œæå‡äº†æ¨¡å‹çš„æ³›åŒ–èƒ½åŠ›ã€‚è¿™ç§æ–¹æ³•ä¸ä»…å¯ä»¥æé«˜æ¨¡å‹åœ¨å®é™…åº”ç”¨ä¸­çš„è¡¨ç°ï¼Œè¿˜èƒ½ä¸ºåç»­çš„ç ”ç©¶æä¾›åšå®çš„æ•°æ®åŸºç¡€ã€‚éšç€æ·±åº¦å­¦ä¹ æŠ€æœ¯çš„ä¸æ–­è¿›æ­¥ï¼ŒåŸºäºYOLOv11çš„çœ¼åº•å›¾åƒå±‚æ¬¡åˆ†å‰²ç³»ç»Ÿå°†ä¸ºçœ¼ç§‘åŒ»å­¦æä¾›æ–°çš„è§£å†³æ–¹æ¡ˆï¼Œæ¨åŠ¨çœ¼åº•ç–¾ç—…çš„æ—©æœŸè¯Šæ–­å’Œæ²»ç–—è¿›ç¨‹ï¼Œå…·æœ‰é‡è¦çš„ä¸´åºŠåº”ç”¨ä»·å€¼å’Œç¤¾ä¼šæ„ä¹‰ã€‚

### 2.è§†é¢‘æ•ˆæœ

[2.1 è§†é¢‘æ•ˆæœ](https://www.bilibili.com/video/BV1bPkFYbEtR/)

### 3.å›¾ç‰‡æ•ˆæœ

![1.png](1.png)

![2.png](2.png)

![3.png](3.png)

##### [é¡¹ç›®æ¶‰åŠçš„æºç æ•°æ®æ¥æºé“¾æ¥](https://kdocs.cn/l/cszuIiCKVNis)**

æ³¨æ„ï¼šæœ¬é¡¹ç›®æä¾›è®­ç»ƒçš„æ•°æ®é›†å’Œè®­ç»ƒæ•™ç¨‹,ç”±äºç‰ˆæœ¬æŒç»­æ›´æ–°,æš‚ä¸æä¾›æƒé‡æ–‡ä»¶ï¼ˆbest.ptï¼‰,è¯·æŒ‰ç…§6.è®­ç»ƒæ•™ç¨‹è¿›è¡Œè®­ç»ƒåå®ç°ä¸Šå›¾æ¼”ç¤ºçš„æ•ˆæœã€‚

### 4.æ•°æ®é›†ä¿¡æ¯

##### 4.1 æœ¬é¡¹ç›®æ•°æ®é›†ç±»åˆ«æ•°ï¼†ç±»åˆ«å

nc: 6
names: ['ILM', 'IS-OS', 'Lower', 'OPL', 'RPE', 'Upper']



è¯¥é¡¹ç›®ä¸ºã€å›¾åƒåˆ†å‰²ã€‘æ•°æ®é›†ï¼Œè¯·åœ¨ã€è®­ç»ƒæ•™ç¨‹å’ŒWebç«¯åŠ è½½æ¨¡å‹æ•™ç¨‹ï¼ˆç¬¬ä¸‰æ­¥ï¼‰ã€‘è¿™ä¸€æ­¥çš„æ—¶å€™æŒ‰ç…§ã€å›¾åƒåˆ†å‰²ã€‘éƒ¨åˆ†çš„æ•™ç¨‹æ¥è®­ç»ƒ

##### 4.2 æœ¬é¡¹ç›®æ•°æ®é›†ä¿¡æ¯ä»‹ç»

æœ¬é¡¹ç›®æ•°æ®é›†ä¿¡æ¯ä»‹ç»

æœ¬é¡¹ç›®æ‰€ä½¿ç”¨çš„æ•°æ®é›†åä¸ºâ€œoct5k_new_newâ€ï¼Œæ—¨åœ¨ä¸ºæ”¹è¿›YOLOv11çš„çœ¼åº•å›¾åƒå±‚æ¬¡åˆ†å‰²ç³»ç»Ÿæä¾›é«˜è´¨é‡çš„è®­ç»ƒæ•°æ®ã€‚è¯¥æ•°æ®é›†ä¸“æ³¨äºçœ¼åº•å›¾åƒçš„åˆ†å‰²ä»»åŠ¡ï¼ŒåŒ…å«äº†å…­ä¸ªä¸»è¦ç±»åˆ«ï¼Œåˆ†åˆ«ä¸ºå†…ç•Œè†œï¼ˆILMï¼‰ã€å…‰æ„Ÿå—å™¨å±‚ä¸è§†ç½‘è†œè‰²ç´ ä¸Šçš®å±‚ï¼ˆIS-OSï¼‰ã€ä¸‹å±‚ï¼ˆLowerï¼‰ã€å¤–æ ¸å±‚ï¼ˆOPLï¼‰ã€è§†ç½‘è†œè‰²ç´ ä¸Šçš®å±‚ï¼ˆRPEï¼‰ä»¥åŠä¸Šå±‚ï¼ˆUpperï¼‰ã€‚è¿™äº›ç±»åˆ«æ¶µç›–äº†çœ¼åº•å›¾åƒä¸­é‡è¦çš„è§£å‰–ç»“æ„ï¼Œå¯¹äºçœ¼ç§‘ç–¾ç—…çš„è¯Šæ–­å’Œæ²»ç–—å…·æœ‰é‡è¦æ„ä¹‰ã€‚

åœ¨æ•°æ®é›†çš„æ„å»ºè¿‡ç¨‹ä¸­ï¼Œæ‰€æœ‰å›¾åƒå‡ç»è¿‡ç²¾å¿ƒæ ‡æ³¨ï¼Œä»¥ç¡®ä¿æ¯ä¸ªç±»åˆ«çš„åˆ†å‰²è¾¹ç•Œæ¸…æ™°ä¸”å‡†ç¡®ã€‚è¿™ç§é«˜è´¨é‡çš„æ ‡æ³¨ä¸ä»…æé«˜äº†æ¨¡å‹è®­ç»ƒçš„æœ‰æ•ˆæ€§ï¼Œä¹Ÿä¸ºåç»­çš„éªŒè¯å’Œæµ‹è¯•æä¾›äº†å¯é çš„åŸºç¡€ã€‚æ•°æ®é›†ä¸­çš„å›¾åƒæ ·æœ¬æ¥è‡ªå¤šç§ä¸åŒçš„çœ¼åº•æ‰«æï¼Œæ¶µç›–äº†ä¸åŒå¹´é¾„æ®µå’Œç—…ç†çŠ¶æ€çš„æ‚£è€…ï¼Œä»è€Œå¢å¼ºäº†æ¨¡å‹çš„æ³›åŒ–èƒ½åŠ›å’Œé€‚åº”æ€§ã€‚

æ­¤å¤–ï¼Œæ•°æ®é›†çš„å¤šæ ·æ€§ä½¿å¾—æ¨¡å‹èƒ½å¤Ÿå­¦ä¹ åˆ°ä¸åŒè§£å‰–ç»“æ„åœ¨ä¸åŒæ¡ä»¶ä¸‹çš„è¡¨ç°ï¼Œè¿›ä¸€æ­¥æå‡äº†åˆ†å‰²ç²¾åº¦ã€‚é€šè¿‡ä½¿ç”¨â€œoct5k_new_newâ€æ•°æ®é›†ï¼Œç ”ç©¶äººå‘˜å¸Œæœ›èƒ½å¤Ÿæ¨åŠ¨çœ¼åº•å›¾åƒåˆ†ææŠ€æœ¯çš„å‘å±•ï¼Œå°¤å…¶æ˜¯åœ¨è‡ªåŠ¨åŒ–åˆ†å‰²å’Œç–¾ç—…æ£€æµ‹æ–¹é¢çš„åº”ç”¨ã€‚æœ€ç»ˆç›®æ ‡æ˜¯å®ç°æ›´ä¸ºç²¾å‡†çš„çœ¼åº•å›¾åƒåˆ†æï¼Œä»¥è¾…åŠ©ä¸´åºŠåŒ»ç”Ÿè¿›è¡Œæ—©æœŸè¯Šæ–­å’Œä¸ªæ€§åŒ–æ²»ç–—æ–¹æ¡ˆçš„åˆ¶å®šã€‚æ•°æ®é›†çš„è®¾è®¡å’Œå®æ–½ä¸ºæœ¬é¡¹ç›®çš„æˆåŠŸå¥ å®šäº†åšå®çš„åŸºç¡€ï¼ŒæœŸå¾…é€šè¿‡è¿™ä¸€ç ”ç©¶ä¸ºçœ¼ç§‘é¢†åŸŸå¸¦æ¥æ–°çš„çªç ´ã€‚

![4.png](4.png)

![5.png](5.png)

![6.png](6.png)

![7.png](7.png)

![8.png](8.png)

### 5.å…¨å¥—é¡¹ç›®ç¯å¢ƒéƒ¨ç½²è§†é¢‘æ•™ç¨‹ï¼ˆé›¶åŸºç¡€æ‰‹æŠŠæ‰‹æ•™å­¦ï¼‰

[5.1 æ‰€éœ€è½¯ä»¶PyCharmå’ŒAnacondaå®‰è£…æ•™ç¨‹ï¼ˆç¬¬ä¸€æ­¥ï¼‰](https://www.bilibili.com/video/BV1BoC1YCEKi/?spm_id_from=333.999.0.0&vd_source=bc9aec86d164b67a7004b996143742dc)




[5.2 å®‰è£…Pythonè™šæ‹Ÿç¯å¢ƒåˆ›å»ºå’Œä¾èµ–åº“å®‰è£…è§†é¢‘æ•™ç¨‹ï¼ˆç¬¬äºŒæ­¥ï¼‰](https://www.bilibili.com/video/BV1ZoC1YCEBw?spm_id_from=333.788.videopod.sections&vd_source=bc9aec86d164b67a7004b996143742dc)

### 6.æ”¹è¿›YOLOv11è®­ç»ƒæ•™ç¨‹å’ŒWeb_UIå‰ç«¯åŠ è½½æ¨¡å‹æ•™ç¨‹ï¼ˆé›¶åŸºç¡€æ‰‹æŠŠæ‰‹æ•™å­¦ï¼‰

[6.1 æ”¹è¿›YOLOv11è®­ç»ƒæ•™ç¨‹å’ŒWeb_UIå‰ç«¯åŠ è½½æ¨¡å‹æ•™ç¨‹ï¼ˆç¬¬ä¸‰æ­¥ï¼‰](https://www.bilibili.com/video/BV1BoC1YCEhR?spm_id_from=333.788.videopod.sections&vd_source=bc9aec86d164b67a7004b996143742dc)


æŒ‰ç…§ä¸Šé¢çš„è®­ç»ƒè§†é¢‘æ•™ç¨‹é“¾æ¥åŠ è½½é¡¹ç›®æä¾›çš„æ•°æ®é›†ï¼Œè¿è¡Œtrain.pyå³å¯å¼€å§‹è®­ç»ƒ
ï»¿


     Epoch   gpu_mem       box       obj       cls    labels  img_size
     1/200     20.8G   0.01576   0.01955  0.007536        22      1280: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 849/849 [14:42<00:00,  1.04s/it]
               Class     Images     Labels          P          R     mAP@.5 mAP@.5:.95: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 213/213 [01:14<00:00,  2.87it/s]
                 all       3395      17314      0.994      0.957      0.0957      0.0843

     Epoch   gpu_mem       box       obj       cls    labels  img_size
     2/200     20.8G   0.01578   0.01923  0.007006        22      1280: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 849/849 [14:44<00:00,  1.04s/it]
               Class     Images     Labels          P          R     mAP@.5 mAP@.5:.95: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 213/213 [01:12<00:00,  2.95it/s]
                 all       3395      17314      0.996      0.956      0.0957      0.0845

     Epoch   gpu_mem       box       obj       cls    labels  img_size
     3/200     20.8G   0.01561    0.0191  0.006895        27      1280: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 849/849 [10:56<00:00,  1.29it/s]
               Class     Images     Labels          P          R     mAP@.5 mAP@.5:.95: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   | 187/213 [00:52<00:00,  4.04it/s]
                 all       3395      17314      0.996      0.957      0.0957      0.0845




###### [é¡¹ç›®æ•°æ®é›†ä¸‹è½½é“¾æ¥](https://kdocs.cn/l/cszuIiCKVNis)

### 7.åŸå§‹YOLOv11ç®—æ³•è®²è§£

YOLOv11æ˜¯Ultralyticsæ¨å‡ºçš„YOLOç³»åˆ—æœ€æ–°ç‰ˆæœ¬ï¼Œä¸“ä¸ºå®ç°å°–ç«¯çš„ç‰©ä½“æ£€æµ‹è€Œè®¾è®¡ã€‚å…¶æ¶æ„å’Œè®­ç»ƒæ–¹æ³•ä¸Šè¿›è¡Œäº†é‡å¤§æ”¹è¿›ï¼Œä½¿ä¹‹ä¸ä»…å…·å¤‡å“è¶Šçš„å‡†ç¡®æ€§å’Œå¤„ç†é€Ÿåº¦ï¼Œè¿˜åœ¨è®¡ç®—æ•ˆç‡ä¸Šå®ç°äº†ä¸€åœºé©å‘½ã€‚å¾—ç›Šäºå…¶æ”¹è¿›çš„ä¸»å¹²å’Œé¢ˆéƒ¨æ¶æ„ï¼ŒYOLOv11åœ¨ç‰¹å¾æå–å’Œå¤„ç†å¤æ‚ä»»åŠ¡æ—¶è¡¨ç°æ›´åŠ å‡ºè‰²ã€‚åœ¨2024å¹´9æœˆ27æ—¥ï¼ŒUltralyticsé€šè¿‡é•¿è¾¾ä¹å°æ—¶çš„åœ¨çº¿ç›´æ’­å‘å¸ƒè¿™ä¸€æ–°ä½œï¼Œå±•ç¤ºäº†å…¶åœ¨è®¡ç®—æœºè§†è§‰é¢†åŸŸçš„é©æ–°ã€‚

YOLOv11é€šè¿‡ç²¾ç»†çš„æ¶æ„è®¾è®¡å’Œä¼˜åŒ–è®­ç»ƒæµç¨‹ï¼Œåœ¨ä¿æŒé«˜ç²¾åº¦çš„åŒæ—¶ï¼Œç¼©å‡äº†å‚æ•°é‡ï¼Œä¸YOLOv8mç›¸æ¯”å‡å°‘äº†22%çš„å‚æ•°ï¼Œä½¿å…¶åœ¨COCOæ•°æ®é›†ä¸Šçš„å¹³å‡å‡†ç¡®åº¦ï¼ˆmAPï¼‰æœ‰æ‰€æå‡ã€‚è¿™ç§æ•ˆç‡çš„æé«˜ä½¿YOLOv11éå¸¸é€‚åˆéƒ¨ç½²åœ¨å„ç§ç¡¬ä»¶ç¯å¢ƒä¸­ï¼ŒåŒ…æ‹¬è¾¹ç¼˜è®¾å¤‡ã€äº‘è®¡ç®—å¹³å°ä»¥åŠæ”¯æŒNVIDIA GPUçš„ç³»ç»Ÿï¼Œç¡®ä¿åœ¨çµæ´»æ€§ä¸Šçš„ä¼˜åŠ¿ã€‚

è¯¥æ¨¡å‹æ”¯æŒå¹¿æ³›çš„ä»»åŠ¡ï¼Œä»å¯¹è±¡æ£€æµ‹ã€å®ä¾‹åˆ†å‰²åˆ°å›¾åƒåˆ†ç±»ã€å§¿æ€ä¼°è®¡å’Œå®šå‘å¯¹è±¡æ£€æµ‹ï¼ˆOBBï¼‰ï¼Œå‡ ä¹è¦†ç›–äº†è®¡ç®—æœºè§†è§‰çš„æ‰€æœ‰ä¸»è¦æŒ‘æˆ˜ã€‚å…¶åˆ›æ–°çš„C3k2å’ŒC2PSAæ¨¡å—æå‡äº†ç½‘ç»œæ·±åº¦å’Œæ³¨æ„åŠ›æœºåˆ¶çš„åº”ç”¨ï¼Œæé«˜äº†ç‰¹å¾æå–çš„æ•ˆç‡å’Œæ•ˆæœã€‚åŒæ—¶ï¼ŒYOLOv11çš„æ”¹è¿›ç½‘ç»œç»“æ„ä¹Ÿä½¿ä¹‹åœ¨å¤æ‚è§†è§‰ä»»åŠ¡ä¸Šå¾—ä»¥ä»å®¹åº”å¯¹ï¼Œæˆä¸ºå„ç±»è®¡ç®—æœºè§†è§‰ä»»åŠ¡çš„å¤šåŠŸèƒ½é€‰æ‹©ã€‚è¿™äº›ç‰¹æ€§ä»¤YOLOv11åœ¨å®æ–½å®æ—¶ç‰©ä½“æ£€æµ‹çš„å„ä¸ªé¢†åŸŸä¸­è¡¨ç°å‡ºä¼—ã€‚
* * *

2024å¹´9æœˆ27æ—¥ï¼ŒUltralyticsåœ¨çº¿ç›´æ’­é•¿è¾¾ä¹å°æ—¶ï¼Œä¸ºYOLO11å¬å¼€â€œå‘å¸ƒä¼šâ€

YOLO11 æ˜¯ Ultralytics YOLO ç³»åˆ—å®æ—¶ç‰©ä½“æ£€æµ‹å™¨çš„æœ€æ–°ç‰ˆæœ¬ï¼Œå®ƒä»¥å°–ç«¯çš„å‡†ç¡®æ€§ã€é€Ÿåº¦å’Œæ•ˆç‡é‡æ–°å®šä¹‰äº†å¯èƒ½æ€§ã€‚åœ¨ä¹‹å‰ YOLO
ç‰ˆæœ¬çš„æ˜¾è‘—è¿›æ­¥çš„åŸºç¡€ä¸Šï¼ŒYOLO11 åœ¨æ¶æ„å’Œè®­ç»ƒæ–¹æ³•æ–¹é¢è¿›è¡Œäº†é‡å¤§æ”¹è¿›ï¼Œä½¿å…¶æˆä¸ºå„ç§è®¡ç®—æœºè§†è§‰ä»»åŠ¡çš„å¤šåŠŸèƒ½é€‰æ‹©ã€‚

![](https://i-blog.csdnimg.cn/direct/a4e1a178833746249720ccee1c82a58b.png)

##### YOLO11ä¸»è¦ç‰¹ç‚¹ï¼š

  * å¢å¼ºçš„ç‰¹å¾æå–ï¼šYOLO11 é‡‡ç”¨äº†æ”¹è¿›çš„ä¸»å¹²å’Œé¢ˆéƒ¨æ¶æ„ï¼Œå¢å¼ºäº†ç‰¹å¾æå–èƒ½åŠ›ï¼Œå¯å®ç°æ›´ç²¾ç¡®çš„å¯¹è±¡æ£€æµ‹å’Œå¤æ‚ä»»åŠ¡æ€§èƒ½ã€‚
  * é’ˆå¯¹æ•ˆç‡å’Œé€Ÿåº¦è¿›è¡Œäº†ä¼˜åŒ–ï¼šYOLO11 å¼•å…¥äº†å®Œå–„çš„æ¶æ„è®¾è®¡å’Œä¼˜åŒ–çš„è®­ç»ƒæµç¨‹ï¼Œå¯æä¾›æ›´å¿«çš„å¤„ç†é€Ÿåº¦ï¼Œå¹¶åœ¨å‡†ç¡®åº¦å’Œæ€§èƒ½ä¹‹é—´ä¿æŒæœ€ä½³å¹³è¡¡ã€‚
  * æ›´å°‘çš„å‚æ•°ï¼Œæ›´é«˜çš„å‡†ç¡®åº¦ï¼šå€ŸåŠ©æ¨¡å‹è®¾è®¡çš„è¿›æ­¥ï¼ŒYOLO11m åœ¨ COCO æ•°æ®é›†ä¸Šå®ç°äº†æ›´é«˜çš„å¹³å‡å‡†ç¡®åº¦ (mAP)ï¼ŒåŒæ—¶ä½¿ç”¨çš„å‚æ•°æ¯” YOLOv8m å°‘ 22%ï¼Œä»è€Œæé«˜äº†è®¡ç®—æ•ˆç‡ï¼ŒåŒæ—¶åˆä¸å½±å“å‡†ç¡®åº¦ã€‚
  * è·¨ç¯å¢ƒçš„é€‚åº”æ€§ï¼šYOLO11 å¯ä»¥æ— ç¼éƒ¨ç½²åœ¨å„ç§ç¯å¢ƒä¸­ï¼ŒåŒ…æ‹¬è¾¹ç¼˜è®¾å¤‡ã€äº‘å¹³å°å’Œæ”¯æŒ NVIDIA GPU çš„ç³»ç»Ÿï¼Œä»è€Œç¡®ä¿æœ€å¤§çš„çµæ´»æ€§ã€‚
  * æ”¯æŒçš„ä»»åŠ¡èŒƒå›´å¹¿æ³›ï¼šæ— è®ºæ˜¯å¯¹è±¡æ£€æµ‹ã€å®ä¾‹åˆ†å‰²ã€å›¾åƒåˆ†ç±»ã€å§¿åŠ¿ä¼°è®¡è¿˜æ˜¯å®šå‘å¯¹è±¡æ£€æµ‹ (OBB)ï¼ŒYOLO11 éƒ½æ—¨åœ¨æ»¡è¶³å„ç§è®¡ç®—æœºè§†è§‰æŒ‘æˆ˜ã€‚

##### æ”¯æŒçš„ä»»åŠ¡å’Œæ¨¡å¼

YOLO11 ä»¥ YOLOv8 ä¸­å¼•å…¥çš„å¤šåŠŸèƒ½æ¨¡å‹ç³»åˆ—ä¸ºåŸºç¡€ï¼Œä¸ºå„ç§è®¡ç®—æœºè§†è§‰ä»»åŠ¡æä¾›å¢å¼ºçš„æ”¯æŒï¼š

Model| Filenames| Task| Inference| Validation| Training| Export  
---|---|---|---|---|---|---  
YOLO11| yolol11n.pt, yolol11s.pt, yolol11m.pt, yolol11x.pt| Detection| âœ…| âœ…|
âœ…| âœ…  
YOLO11-seg| yolol11n-seg.pt, yolol11s-seg.pt, yolol11m-seg.pt,
yolol11x-seg.pt| Instance Segmentation| âœ…| âœ…| âœ…| âœ…  
YOLO11-pose| yolol11n-pose.pt, yolol11s-pose.pt, yolol11m-pose.pt,
yolol11x-pose.pt| Pose/Keypoints| âœ…| âœ…| âœ…| âœ…  
YOLO11-obb| yolol11n-obb.pt, yolol11s-obb.pt, yolol11m-obb.pt,
yolol11x-obb.pt| Oriented Detection| âœ…| âœ…| âœ…| âœ…  
YOLO11-cls| yolol11n-cls.pt, yolol11s-cls.pt, yolol11m-cls.pt,
yolol11x-cls.pt| Classification| âœ…| âœ…| âœ…| âœ…  
  
##### ç®€å•çš„ YOLO11 è®­ç»ƒå’Œæ¨ç†ç¤ºä¾‹

ä»¥ä¸‹ç¤ºä¾‹é€‚ç”¨äºç”¨äºå¯¹è±¡æ£€æµ‹çš„ YOLO11 Detect æ¨¡å‹ã€‚

    
    
    from ultralytics import YOLO
    
    # Load a model
    model = YOLO("yolo11n.pt")
    
    # Train the model
    train_results = model.train(
        data="coco8.yaml",  # path to dataset YAML
        epochs=100,  # number of training epochs
        imgsz=640,  # training image size
        device="cpu",  # device to run on, i.e. device=0 or device=0,1,2,3 or device=cpu
    )
    
    # Evaluate model performance on the validation set
    metrics = model.val()
    
    # Perform object detection on an image
    results = model("path/to/image.jpg")
    results[0].show()
    
    # Export the model to ONNX format
    path = model.export(format="onnx")  # return path to exported model

##### æ”¯æŒéƒ¨ç½²äºè¾¹ç¼˜è®¾å¤‡

YOLO11 ä¸“ä¸ºé€‚åº”å„ç§ç¯å¢ƒè€Œè®¾è®¡ï¼ŒåŒ…æ‹¬è¾¹ç¼˜è®¾å¤‡ã€‚å…¶ä¼˜åŒ–çš„æ¶æ„å’Œé«˜æ•ˆçš„å¤„ç†èƒ½åŠ›ä½¿å…¶é€‚åˆéƒ¨ç½²åœ¨è¾¹ç¼˜è®¾å¤‡ã€äº‘å¹³å°å’Œæ”¯æŒ NVIDIA GPU
çš„ç³»ç»Ÿä¸Šã€‚è¿™ç§çµæ´»æ€§ç¡®ä¿ YOLO11 å¯ç”¨äºå„ç§åº”ç”¨ï¼Œä»ç§»åŠ¨è®¾å¤‡ä¸Šçš„å®æ—¶æ£€æµ‹åˆ°äº‘ç¯å¢ƒä¸­çš„å¤æ‚åˆ†å‰²ä»»åŠ¡ã€‚æœ‰å…³éƒ¨ç½²é€‰é¡¹çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…å¯¼å‡ºæ–‡æ¡£ã€‚

##### YOLOv11 yamlæ–‡ä»¶

    
    
    # Ultralytics YOLO ğŸš€, AGPL-3.0 license
    # YOLO11 object detection model with P3-P5 outputs. For Usage examples see https://docs.ultralytics.com/tasks/detect
    
    # Parameters
    nc: 80 # number of classes
    scales: # model compound scaling constants, i.e. 'model=yolo11n.yaml' will call yolo11.yaml with scale 'n'
      # [depth, width, max_channels]
      n: [0.50, 0.25, 1024] # summary: 319 layers, 2624080 parameters, 2624064 gradients, 6.6 GFLOPs
      s: [0.50, 0.50, 1024] # summary: 319 layers, 9458752 parameters, 9458736 gradients, 21.7 GFLOPs
      m: [0.50, 1.00, 512] # summary: 409 layers, 20114688 parameters, 20114672 gradients, 68.5 GFLOPs
      l: [1.00, 1.00, 512] # summary: 631 layers, 25372160 parameters, 25372144 gradients, 87.6 GFLOPs
      x: [1.00, 1.50, 512] # summary: 631 layers, 56966176 parameters, 56966160 gradients, 196.0 GFLOPs
    
    # YOLO11n backbone
    backbone:
      # [from, repeats, module, args]
      - [-1, 1, Conv, [64, 3, 2]] # 0-P1/2
      - [-1, 1, Conv, [128, 3, 2]] # 1-P2/4
      - [-1, 2, C3k2, [256, False, 0.25]]
      - [-1, 1, Conv, [256, 3, 2]] # 3-P3/8
      - [-1, 2, C3k2, [512, False, 0.25]]
      - [-1, 1, Conv, [512, 3, 2]] # 5-P4/16
      - [-1, 2, C3k2, [512, True]]
      - [-1, 1, Conv, [1024, 3, 2]] # 7-P5/32
      - [-1, 2, C3k2, [1024, True]]
      - [-1, 1, SPPF, [1024, 5]] # 9
      - [-1, 2, C2PSA, [1024]] # 10
    
    # YOLO11n head
    head:
      - [-1, 1, nn.Upsample, [None, 2, "nearest"]]
      - [[-1, 6], 1, Concat, [1]] # cat backbone P4
      - [-1, 2, C3k2, [512, False]] # 13
    
      - [-1, 1, nn.Upsample, [None, 2, "nearest"]]
      - [[-1, 4], 1, Concat, [1]] # cat backbone P3
      - [-1, 2, C3k2, [256, False]] # 16 (P3/8-small)
    
      - [-1, 1, Conv, [256, 3, 2]]
      - [[-1, 13], 1, Concat, [1]] # cat head P4
      - [-1, 2, C3k2, [512, False]] # 19 (P4/16-medium)
    
      - [-1, 1, Conv, [512, 3, 2]]
      - [[-1, 10], 1, Concat, [1]] # cat head P5
      - [-1, 2, C3k2, [1024, True]] # 22 (P5/32-large)
    
      - [[16, 19, 22], 1, Detect, [nc]] # Detect(P3, P4, P5)
    

**YOLO11å’ŒYOLOv8 yamlæ–‡ä»¶çš„åŒºåˆ«**

![](https://i-blog.csdnimg.cn/direct/a8f3766a015c4ad2a49411ab710b3477.png)

##### æ”¹è¿›æ¨¡å—ä»£ç 

  * C3k2 

    
    
    class C3k2(C2f):
        """Faster Implementation of CSP Bottleneck with 2 convolutions."""
    
        def __init__(self, c1, c2, n=1, c3k=False, e=0.5, g=1, shortcut=True):
            """Initializes the C3k2 module, a faster CSP Bottleneck with 2 convolutions and optional C3k blocks."""
            super().__init__(c1, c2, n, shortcut, g, e)
            self.m = nn.ModuleList(
                C3k(self.c, self.c, 2, shortcut, g) if c3k else Bottleneck(self.c, self.c, shortcut, g) for _ in range(n)
            )

C3k2ï¼Œå®ƒæ˜¯å…·æœ‰ä¸¤ä¸ªå·ç§¯çš„CSPï¼ˆPartial Cross Stageï¼‰ç“¶é¢ˆæ¶æ„çš„æ›´å¿«å®ç°ã€‚

**ç±»ç»§æ‰¿ï¼š**

  * `C3k2`ç»§æ‰¿è‡ªç±»`C2f`ã€‚è¿™è¡¨æ˜`C2f`å¾ˆå¯èƒ½å®ç°äº†ç»è¿‡ä¿®æ”¹çš„åŸºæœ¬CSPç»“æ„ï¼Œè€Œ`C3k2`è¿›ä¸€æ­¥ä¼˜åŒ–æˆ–ä¿®æ”¹äº†æ­¤ç»“æ„ã€‚

**æ„é€ å‡½æ•°ï¼ˆ`__init__`ï¼‰ï¼š**

  * `c1`ï¼šè¾“å…¥é€šé“ã€‚

  * `c2`ï¼šè¾“å‡ºé€šé“ã€‚

  * `n`ï¼šç“¶é¢ˆå±‚æ•°ï¼ˆé»˜è®¤ä¸º1ï¼‰ã€‚

  * `c3k`ï¼šä¸€ä¸ªå¸ƒå°”æ ‡å¿—ï¼Œç¡®å®šæ˜¯å¦ä½¿ç”¨`C3k`å—æˆ–å¸¸è§„`Bottleneck`å—ã€‚

  * `e`ï¼šæ‰©å±•æ¯”ç‡ï¼Œæ§åˆ¶éšè—å±‚çš„å®½åº¦ï¼ˆé»˜è®¤ä¸º0.5ï¼‰ã€‚

  * `g`ï¼šåˆ†ç»„å·ç§¯çš„ç»„å½’ä¸€åŒ–å‚æ•°æˆ–ç»„æ•°ï¼ˆé»˜è®¤å€¼ä¸º 1ï¼‰ã€‚

  * `shortcut`ï¼šä¸€ä¸ªå¸ƒå°”å€¼ï¼Œç”¨äºç¡®å®šæ˜¯å¦åœ¨ç½‘ç»œä¸­åŒ…å«å¿«æ·æ–¹å¼è¿æ¥ï¼ˆé»˜è®¤å€¼ä¸º `True`ï¼‰ã€‚

**åˆå§‹åŒ–ï¼š**

  * `super().__init__(c1, c2, n, short-cut, g, e)` è°ƒç”¨çˆ¶ç±» `C2f` çš„æ„é€ å‡½æ•°ï¼Œåˆå§‹åŒ–æ ‡å‡† CSP ç»„ä»¶ï¼Œå¦‚é€šé“æ•°ã€å¿«æ·æ–¹å¼ã€ç»„ç­‰ã€‚

**æ¨¡å—åˆ—è¡¨ï¼ˆ`self.m`ï¼‰ï¼š**

  * `nn.ModuleList` å­˜å‚¨ `C3k` æˆ– `Bottleneck` æ¨¡å—ï¼Œå…·ä½“å–å†³äº `c3k` çš„å€¼ã€‚

  * å¦‚æœ `c3k` ä¸º `True`ï¼Œå®ƒä¼šåˆå§‹åŒ– `C3k` æ¨¡å—ã€‚`C3k` æ¨¡å—æ¥æ”¶ä»¥ä¸‹å‚æ•°ï¼š

  * `self.c`ï¼šé€šé“æ•°ï¼ˆæºè‡ª `C2f`ï¼‰ã€‚

  * `2`ï¼šè¿™è¡¨ç¤ºåœ¨ `C3k` å—å†…ä½¿ç”¨äº†ä¸¤ä¸ªå·ç§¯å±‚ã€‚

  * `shortcut` å’Œ `g`ï¼šä» `C3k2` æ„é€ å‡½æ•°ä¼ é€’ã€‚

  * å¦‚æœ `c3k` ä¸º `False`ï¼Œåˆ™åˆå§‹åŒ–æ ‡å‡† `Bottleneck` æ¨¡å—ã€‚

`for _ in range(n)` è¡¨ç¤ºå°†åˆ›å»º `n` ä¸ªè¿™æ ·çš„å—ã€‚

**æ€»ç»“ï¼š**

  * `C3k2` å®ç°äº† CSP ç“¶é¢ˆæ¶æ„ï¼Œå¯ä»¥é€‰æ‹©ä½¿ç”¨è‡ªå®šä¹‰ `C3k` å—ï¼ˆå…·æœ‰ä¸¤ä¸ªå·ç§¯ï¼‰æˆ–æ ‡å‡† `Bottleneck` å—ï¼Œå…·ä½“å–å†³äº `c3k` æ ‡å¿—ã€‚

  * C2PSA

    
    
    class C2PSA(nn.Module):
        """
        C2PSA module with attention mechanism for enhanced feature extraction and processing.
    
        This module implements a convolutional block with attention mechanisms to enhance feature extraction and processing
        capabilities. It includes a series of PSABlock modules for self-attention and feed-forward operations.
    
        Attributes:
            c (int): Number of hidden channels.
            cv1 (Conv): 1x1 convolution layer to reduce the number of input channels to 2*c.
            cv2 (Conv): 1x1 convolution layer to reduce the number of output channels to c.
            m (nn.Sequential): Sequential container of PSABlock modules for attention and feed-forward operations.
    
        Methods:
            forward: Performs a forward pass through the C2PSA module, applying attention and feed-forward operations.
    
        Notes:
            This module essentially is the same as PSA module, but refactored to allow stacking more PSABlock modules.
    
        Examples:
            >>> c2psa = C2PSA(c1=256, c2=256, n=3, e=0.5)
            >>> input_tensor = torch.randn(1, 256, 64, 64)
            >>> output_tensor = c2psa(input_tensor)
        """
    
        def __init__(self, c1, c2, n=1, e=0.5):
            """Initializes the C2PSA module with specified input/output channels, number of layers, and expansion ratio."""
            super().__init__()
            assert c1 == c2
            self.c = int(c1 * e)
            self.cv1 = Conv(c1, 2 * self.c, 1, 1)
            self.cv2 = Conv(2 * self.c, c1, 1)
    
            self.m = nn.Sequential(*(PSABlock(self.c, attn_ratio=0.5, num_heads=self.c // 64) for _ in range(n)))
    
        def forward(self, x):
            """Processes the input tensor 'x' through a series of PSA blocks and returns the transformed tensor."""
            a, b = self.cv1(x).split((self.c, self.c), dim=1)
            b = self.m(b)
            return self.cv2(torch.cat((a, b), 1))

`C2PSA` æ¨¡å—æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰ç¥ç»ç½‘ç»œå±‚ï¼Œå¸¦æœ‰æ³¨æ„åŠ›æœºåˆ¶ï¼Œç”¨äºå¢å¼ºç‰¹å¾æå–å’Œå¤„ç†ã€‚

**ç±»æ¦‚è¿°**

  * **ç›®çš„ï¼š**

  * `C2PSA` æ¨¡å—å¼•å…¥äº†ä¸€ä¸ªå·ç§¯å—ï¼Œåˆ©ç”¨æ³¨æ„åŠ›æœºåˆ¶æ¥æ”¹è¿›ç‰¹å¾æå–å’Œå¤„ç†ã€‚

  * å®ƒä½¿ç”¨ä¸€ç³»åˆ— `PSABlock` æ¨¡å—ï¼Œè¿™äº›æ¨¡å—å¯èƒ½ä»£è¡¨æŸç§å½¢å¼çš„ä½ç½®è‡ªæ³¨æ„åŠ› (PSA)ï¼Œå¹¶ä¸”è¯¥æ¶æ„æ—¨åœ¨å…è®¸å †å å¤šä¸ª `PSABlock` å±‚ã€‚

**æ„é€ å‡½æ•°ï¼ˆ`__init__`ï¼‰ï¼š**

  * **å‚æ•°ï¼š**

  * `c1`ï¼šè¾“å…¥é€šé“ï¼ˆå¿…é¡»ç­‰äº `c2`ï¼‰ã€‚

  * `c2`ï¼šè¾“å‡ºé€šé“ï¼ˆå¿…é¡»ç­‰äº `c1`ï¼‰ã€‚

  * `n`ï¼šè¦å †å çš„ `PSABlock` æ¨¡å—æ•°é‡ï¼ˆé»˜è®¤å€¼ä¸º 1ï¼‰ã€‚

  * `e`ï¼šæ‰©å±•æ¯”ç‡ï¼Œç”¨äºè®¡ç®—éšè—é€šé“çš„æ•°é‡ï¼ˆé»˜è®¤å€¼ä¸º 0.5ï¼‰ã€‚

  * **å±æ€§ï¼š**

  * `self.c`ï¼šéšè—é€šé“æ•°ï¼Œè®¡ç®—ä¸º `int(c1 * e)`ã€‚

  * `self.cv1`ï¼šä¸€ä¸ª `1x1` å·ç§¯ï¼Œå°†è¾“å…¥é€šé“æ•°ä» `c1` å‡å°‘åˆ° `2 * self.c`ã€‚è¿™ä¸ºå°†è¾“å…¥åˆ†æˆä¸¤éƒ¨åˆ†åšå¥½å‡†å¤‡ã€‚

  * `self.cv2`ï¼šå¦ä¸€ä¸ª `1x1` å·ç§¯ï¼Œå¤„ç†åå°†é€šé“ç»´åº¦æ¢å¤å› `c1`ã€‚

  * `self.m`ï¼šä¸€ç³»åˆ— `PSABlock` æ¨¡å—ã€‚æ¯ä¸ª `PSABlock` æ¥æ”¶ `self.c` é€šé“ï¼Œæ³¨æ„å¤´çš„æ•°é‡ä¸º `self.c // 64`ã€‚æ¯ä¸ªå—åº”ç”¨æ³¨æ„å’Œå‰é¦ˆæ“ä½œã€‚

**å‰å‘æ–¹æ³•ï¼š**

  * **è¾“å…¥ï¼š**

  * `x`ï¼Œè¾“å…¥å¼ é‡ã€‚

  * **æ“ä½œï¼š**

  1. `self.cv1(x)` åº”ç”¨ `1x1` å·ç§¯ï¼Œå°†è¾“å…¥é€šé“å¤§å°ä» `c1` å‡å°åˆ° `2 * self.c`ã€‚

  2. ç”Ÿæˆçš„å¼ é‡æ²¿é€šé“ç»´åº¦åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œ`a` å’Œ `b`ã€‚

  * `a`ï¼šç¬¬ä¸€ä¸ª `self.c` é€šé“ã€‚

  * `b`ï¼šå‰©ä½™çš„ `self.c` é€šé“ã€‚

  1. `b` é€šè¿‡é¡ºåºå®¹å™¨ `self.m`ï¼Œå®ƒæ˜¯ `PSABlock` æ¨¡å—çš„å †æ ˆã€‚è¿™éƒ¨åˆ†ç»è¿‡åŸºäºæ³¨æ„çš„å¤„ç†ã€‚

  2. å¤„ç†åçš„å¼ é‡ `b` ä¸ `a` è¿æ¥ã€‚

  3. `self.cv2` åº”ç”¨ `1x1` å·ç§¯ï¼Œå°†é€šé“å¤§å°æ¢å¤ä¸º `c1`ã€‚

  * **è¾“å‡ºï¼š**

  * åº”ç”¨æ³¨æ„å’Œå·ç§¯æ“ä½œåçš„å˜æ¢åçš„å¼ é‡ã€‚

**æ€»ç»“ï¼š**

  * **C2PSA** æ˜¯ä¸€ä¸ªå¢å¼ºå‹å·ç§¯æ¨¡å—ï¼Œå®ƒé€šè¿‡å †å çš„ `PSABlock` æ¨¡å—åº”ç”¨ä½ç½®è‡ªæ³¨æ„åŠ›ã€‚å®ƒæ‹†åˆ†è¾“å…¥å¼ é‡ï¼Œå°†æ³¨æ„åŠ›åº”ç”¨äºå…¶ä¸­ä¸€éƒ¨åˆ†ï¼Œç„¶åé‡æ–°ç»„åˆå¹¶é€šè¿‡æœ€ç»ˆå·ç§¯å¯¹å…¶è¿›è¡Œå¤„ç†ã€‚æ­¤ç»“æ„æœ‰åŠ©äºä»è¾“å…¥æ•°æ®ä¸­æå–å¤æ‚ç‰¹å¾ã€‚

##### ç½‘ç»œç»“æ„

![](https://i-blog.csdnimg.cn/direct/761af09befeb45adafae36b679424b26.png)

![](https://i-blog.csdnimg.cn/direct/45e481e295ad458fa7fe4c252fbd5d83.png)




### 8.200+ç§å…¨å¥—æ”¹è¿›YOLOV11åˆ›æ–°ç‚¹åŸç†è®²è§£

#### 8.1 200+ç§å…¨å¥—æ”¹è¿›YOLOV11åˆ›æ–°ç‚¹åŸç†è®²è§£å¤§å…¨

ç”±äºç¯‡å¹…é™åˆ¶ï¼Œæ¯ä¸ªåˆ›æ–°ç‚¹çš„å…·ä½“åŸç†è®²è§£å°±ä¸å…¨éƒ¨å±•å¼€ï¼Œå…·ä½“è§ä¸‹åˆ—ç½‘å€ä¸­çš„æ”¹è¿›æ¨¡å—å¯¹åº”é¡¹ç›®çš„æŠ€æœ¯åŸç†åšå®¢ç½‘å€ã€Blogã€‘ï¼ˆåˆ›æ–°ç‚¹å‡ä¸ºæ¨¡å—åŒ–æ­å»ºï¼ŒåŸç†é€‚é…YOLOv5~YOLOv11ç­‰å„ç§ç‰ˆæœ¬ï¼‰

[æ”¹è¿›æ¨¡å—æŠ€æœ¯åŸç†åšå®¢ã€Blogã€‘ç½‘å€é“¾æ¥](https://gitee.com/qunmasj/good)

![9.png](9.png)

#### 8.2 ç²¾é€‰éƒ¨åˆ†æ”¹è¿›YOLOV11åˆ›æ–°ç‚¹åŸç†è®²è§£

###### è¿™é‡ŒèŠ‚é€‰éƒ¨åˆ†æ”¹è¿›åˆ›æ–°ç‚¹å±•å¼€åŸç†è®²è§£(å®Œæ•´çš„æ”¹è¿›åŸç†è§ä¸Šå›¾å’Œ[æ”¹è¿›æ¨¡å—æŠ€æœ¯åŸç†åšå®¢é“¾æ¥](https://gitee.com/qunmasj/good)ã€å¦‚æœæ­¤å°èŠ‚çš„å›¾åŠ è½½å¤±è´¥å¯ä»¥é€šè¿‡CSDNæˆ–è€…Githubæœç´¢è¯¥åšå®¢çš„æ ‡é¢˜è®¿é—®åŸå§‹åšå®¢ï¼ŒåŸå§‹åšå®¢å›¾ç‰‡æ˜¾ç¤ºæ­£å¸¸ã€‘
ï»¿### å¯å˜æ€§å·ç§¯DCNç®€ä»‹
å·ç§¯ç¥ç»ç½‘ç»œç”±äºå…¶æ„å»ºæ¨¡å—ä¸­å›ºå®šçš„å‡ ä½•ç»“æ„ï¼Œæœ¬è´¨ä¸Šå—é™äºæ¨¡å‹å‡ ä½•å˜æ¢ã€‚ä¸ºäº†æé«˜å·ç§¯ç¥ç»ç½‘ç»œçš„è½¬æ¢å»ºæ¨¡èƒ½åŠ›ï¼Œã€ŠDeformable Convolutional Networksã€‹ä½œè€…æå‡ºäº†ä¸¤ä¸ªæ¨¡å—ï¼šå¯å˜å½¢å·ç§¯ï¼ˆdeformable convolutionï¼‰å’Œå¯å˜å½¢RoIæ± ï¼ˆdeformable RoI poolingï¼‰ã€‚è¿™ä¸¤ä¸ªæ¨¡å—å‡åŸºäºç”¨é¢å¤–çš„åç§»æ¥å¢åŠ æ¨¡å—ä¸­çš„ç©ºé—´é‡‡æ ·ä½ç½®ä»¥åŠä»ç›®æ ‡ä»»åŠ¡ä¸­å­¦ä¹ åç§»çš„æ€æƒ³ï¼Œè€Œä¸éœ€è¦é¢å¤–çš„ç›‘ç£ã€‚

ç¬¬ä¸€æ¬¡è¯æ˜äº†åœ¨æ·±åº¦ç¥ç»ç½‘ç»œä¸­å­¦ä¹ å¯†é›†ç©ºé—´å˜æ¢ï¼ˆdense spatial transformationï¼‰å¯¹äºå¤æ‚çš„è§†è§‰ä»»åŠ¡æ˜¯æœ‰æ•ˆçš„

è§†è§‰è¯†åˆ«ä¸­çš„ä¸€ä¸ªå…³é”®æŒ‘æˆ˜æ˜¯å¦‚ä½•é€‚åº”å¯¹è±¡æ¯”ä¾‹ã€å§¿æ€ã€è§†ç‚¹å’Œé›¶ä»¶å˜å½¢ä¸­çš„å‡ ä½•å˜åŒ–æˆ–æ¨¡å‹å‡ ä½•å˜æ¢ã€‚ä¸€èˆ¬æœ‰ä¸¤ç§æ–¹æ³•å®ç°ï¼š
1ï¼‰å»ºç«‹å…·æœ‰è¶³å¤ŸæœŸæœ›å˜åŒ–çš„è®­ç»ƒæ•°æ®é›†ã€‚è¿™é€šå¸¸é€šè¿‡å¢åŠ ç°æœ‰çš„æ•°æ®æ ·æœ¬æ¥å®ç°ï¼Œä¾‹å¦‚é€šè¿‡ä»¿å°„å˜æ¢ã€‚ä½†æ˜¯è®­ç»ƒæˆæœ¬æ˜‚è´µè€Œä¸”æ¨¡å‹å‚æ•°åºå¤§ã€‚
2ï¼‰ä½¿ç”¨å˜æ¢ä¸å˜ï¼ˆtransformation-invariantï¼‰çš„ç‰¹å¾å’Œç®—æ³•ã€‚æ¯”å¦‚æ¯”è¾ƒæœ‰åçš„SIFT(å°ºåº¦ä¸å˜ç‰¹å¾å˜æ¢)ä¾¿æ˜¯è¿™ä¸€ç±»çš„ä»£è¡¨ç®—æ³•ã€‚

ä½†ä»¥ä¸Šçš„æ–¹æ³•æœ‰ä¸¤ä¸ªç¼ºç‚¹ï¼š
1ï¼‰å‡ ä½•å˜æ¢è¢«å‡å®šä¸ºå›ºå®šçš„å’Œå·²çŸ¥çš„ï¼Œè¿™äº›å…ˆéªŒçŸ¥è¯†è¢«ç”¨æ¥æ‰©å……æ•°æ®ï¼Œè®¾è®¡ç‰¹å¾å’Œç®—æ³•ã€‚ä¸ºæ­¤ï¼Œè¿™ä¸ªå‡è®¾é˜»æ­¢äº†å¯¹å…·æœ‰æœªçŸ¥å‡ ä½•å˜æ¢çš„æ–°ä»»åŠ¡çš„æ¨å¹¿ï¼Œä»è€Œå¯¼è‡´è¿™äº›å‡ ä½•å˜æ¢å¯èƒ½æ²¡æœ‰è¢«æ­£ç¡®å»ºæ¨¡ã€‚
2ï¼‰å¯¹äºä¸å˜ç‰¹å¾å’Œç®—æ³•è¿›è¡Œæ‰‹åŠ¨è®¾è®¡ï¼Œå¯¹äºè¿‡äºå¤æ‚çš„å˜æ¢å¯èƒ½æ˜¯å›°éš¾çš„æˆ–ä¸å¯è¡Œçš„ã€‚

å·ç§¯ç¥ç»ç½‘ç»œæœ¬è´¨ä¸Šå±€é™äºæ¨¡æ‹Ÿå¤§å‹æœªçŸ¥è½¬æ¢ã€‚å±€é™æ€§æºäºCNNæ¨¡å—çš„å›ºå®šå‡ ä½•ç»“æ„ï¼šå·ç§¯å•å…ƒåœ¨å›ºå®šä½ç½®å¯¹è¾“å…¥ç‰¹å¾å›¾è¿›è¡Œé‡‡æ ·ï¼›æ± åŒ–å±‚ä»¥å›ºå®šæ¯”ç‡é™ä½ç‰¹å¾çŸ©é˜µåˆ†è¾¨ç‡ï¼›RoIï¼ˆæ„Ÿå…´è¶£åŒºåŸŸï¼‰æ± åŒ–å±‚å°†RoIåˆ†æˆå›ºå®šçš„ç©ºé—´ç®±ï¼ˆspatial binsï¼‰ç­‰ã€‚ç¼ºä¹å¤„ç†å‡ ä½•å˜æ¢çš„å†…éƒ¨æœºåˆ¶ã€‚

è¿™ç§å†…éƒ¨æœºåˆ¶çš„ç¼ºä¹ä¼šå¯¼è‡´ä¸€äº›é—®é¢˜ï¼Œä¸¾ä¸ªä¾‹å­ã€‚åŒä¸€ä¸ªCNNå±‚ä¸­æ‰€æœ‰æ¿€æ´»å•å…ƒçš„æ„Ÿå—é‡å¤§å°æ˜¯ç›¸åŒçš„ï¼Œä½†æ˜¯è¿™æ˜¯ä¸å¯å–çš„ã€‚å› ä¸ºä¸åŒçš„ä½ç½®å¯èƒ½å¯¹åº”äºå…·æœ‰ä¸åŒå°ºåº¦æˆ–å˜å½¢çš„å¯¹è±¡ï¼Œæ‰€ä»¥å°ºåº¦æˆ–æ„Ÿå—é‡å¤§å°çš„è‡ªé€‚åº”ç¡®å®šå¯¹äºå…·æœ‰ç²¾ç»†å®šä½çš„è§†è§‰è¯†åˆ«æ˜¯æ¸´æœ›çš„ã€‚

å¯¹äºè¿™äº›é—®é¢˜ï¼Œä½œè€…æå‡ºäº†ä¸¤ä¸ªæ¨¡å—æé«˜CNNså¯¹å‡ ä½•å˜æ¢å»ºæ¨¡çš„èƒ½åŠ›ã€‚


deformable convolutionï¼ˆå¯å˜å½¢å·ç§¯ï¼‰
å°†2Dåç§»é‡æ·»åŠ åˆ°æ ‡å‡†å·ç§¯ä¸­çš„å¸¸è§„ç½‘æ ¼é‡‡æ ·ä½ç½®ï¼Œä½¿å¾—é‡‡æ ·ç½‘æ ¼èƒ½å¤Ÿè‡ªç”±å˜å½¢ã€‚é€šè¿‡é¢å¤–çš„å·ç§¯å±‚ï¼Œä»å‰é¢çš„ç‰¹å¾æ˜ å°„ä¸­å­¦ä¹ åç§»ã€‚å› æ­¤ï¼Œå˜å½¢é‡‡ç”¨å±€éƒ¨ã€å¯†é›†å’Œè‡ªé€‚åº”çš„æ–¹å¼å–å†³äºè¾“å…¥ç‰¹å¾ã€‚
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/3291fa03a6014fceb820fa57ad10bdc7.png)

deformable RoI poolingï¼ˆå¯å˜å½¢RoIæ± åŒ–ï¼‰
ä¸ºå…ˆå‰RoIæ± åŒ–çš„å¸¸è§„åº“ï¼ˆbinï¼‰åˆ†åŒºä¸­çš„æ¯ä¸ªåº“ä½ç½®ï¼ˆbin partitionï¼‰å¢åŠ äº†ä¸€ä¸ªåç§»é‡ã€‚ç±»ä¼¼åœ°ï¼Œåç§»æ˜¯ä»å‰é¢çš„ç‰¹å¾å›¾å’Œæ„Ÿå…´è¶£åŒºåŸŸä¸­å­¦ä¹ çš„ï¼Œä»è€Œèƒ½å¤Ÿå¯¹å…·æœ‰ä¸åŒå½¢çŠ¶çš„å¯¹è±¡è¿›è¡Œè‡ªé€‚åº”éƒ¨ä»¶å®šä½ï¼ˆadaptive part localizationï¼‰ã€‚

#### Deformable Convolutional Networks
Deformable Convolution
2Då·ç§¯ç”±ä¸¤ä¸ªæ­¥éª¤ç»„æˆï¼š
1ï¼‰åœ¨è¾“å…¥ç‰¹å¾å›¾x xxä¸Šä½¿ç”¨è§„åˆ™ç½‘æ ¼R RRè¿›è¡Œé‡‡æ ·ã€‚
2ï¼‰æŠŠè¿™äº›é‡‡æ ·ç‚¹ä¹˜ä¸åŒæƒé‡w wwåç›¸åŠ ã€‚

ç½‘æ ¼Rå®šä¹‰æ„Ÿå—é‡å¤§å°å’Œæ‰©å¼ ç¨‹åº¦ï¼Œæ¯”å¦‚å†…æ ¸å¤§å°ä¸º3x3ï¼Œæ‰©å¼ ç¨‹åº¦ä¸º1çš„ç½‘æ ¼Rå¯ä»¥è¡¨ç¤ºä¸ºï¼š
R = { ( âˆ’ 1 , âˆ’ 1 ) , ( âˆ’ 1 , 0 ) , â€¦ , ( 0 , 1 ) , ( 1 , 1 ) } R = \{(-1,-1),(-1,0),\dots,(0,1),(1,1)\}
R={(âˆ’1,âˆ’1),(âˆ’1,0),â€¦,(0,1),(1,1)}

â€‹
 ä¸€èˆ¬ä¸ºå°æ•°ï¼Œä½¿ç”¨åŒçº¿æ€§æ’å€¼è¿›è¡Œå¤„ç†ã€‚ï¼ˆæŠŠå°æ•°åæ ‡åˆ†è§£åˆ°ç›¸é‚»çš„å››ä¸ªæ•´æ•°åæ ‡ç‚¹æ¥è®¡ç®—ç»“æœï¼‰
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/43928250733543c89a9d4a3c18bd190e.png)

å…·ä½“æ“ä½œå¦‚å›¾æ‰€ç¤ºï¼š
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/a400582501324d819f5d8e07599c7827.png)

é¦–å…ˆå¯¹è¾“å…¥ç‰¹å¾å±‚è¿›è¡Œä¸€ä¸ªæ™®é€šçš„3x3å·ç§¯å¤„ç†å¾—åˆ°åç§»åŸŸï¼ˆoffset fieldï¼‰ã€‚åç§»åŸŸç‰¹å¾å›¾å…·æœ‰ä¸è¾“å…¥ç‰¹å¾å›¾ç›¸åŒçš„ç©ºé—´åˆ†è¾¨ç‡ï¼Œchannelsç»´åº¦2Nå¯¹åº”äºNä¸ª2Dï¼ˆxyä¸¤ä¸ªæ–¹å‘ï¼‰åç§»ã€‚å…¶ä¸­çš„Næ˜¯åŸè¾“å…¥ç‰¹å¾å›¾ä¸Šæ‰€å…·æœ‰çš„Nä¸ªchannelsï¼Œä¹Ÿå°±æ˜¯è¾“å…¥è¾“å‡ºchannelsä¿æŒä¸å˜ï¼Œè¿™é‡Œxyä¸¤ä¸ªchannelsåˆ†åˆ«å¯¹è¾“å‡ºç‰¹å¾å›¾ä¸Šçš„ä¸€ä¸ªchannelsè¿›è¡Œåç§»ã€‚ç¡®å®šé‡‡æ ·ç‚¹åå°±é€šè¿‡ä¸ç›¸å¯¹åº”çš„æƒé‡wç‚¹ä¹˜ç›¸åŠ å¾—åˆ°è¾“å‡ºç‰¹å¾å›¾ä¸Šè¯¥ç‚¹æœ€ç»ˆå€¼ã€‚

å‰é¢ä¹Ÿæåˆ°è¿‡ï¼Œç”±äºè¿™é‡Œxyä¸¤ä¸ªæ–¹å‘æ‰€è®­ç»ƒå‡ºæ¥çš„åç§»é‡ä¸€èˆ¬æ¥è¯´æ˜¯ä¸€ä¸ªå°æ•°ï¼Œé‚£ä¹ˆä¸ºäº†å¾—åˆ°è¿™ä¸ªç‚¹æ‰€å¯¹åº”çš„æ•°å€¼ï¼Œä¼šé‡‡ç”¨åŒçº¿æ€§æ’å€¼çš„æ–¹æ³•ï¼Œä»æœ€è¿‘çš„å››ä¸ªé‚»è¿‘åæ ‡ç‚¹ä¸­è®¡ç®—å¾—åˆ°è¯¥åç§»ç‚¹çš„æ•°å€¼ï¼Œå…¬å¼å¦‚ä¸‹ï¼š
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/f55ea139adcb434eadb735d4f936a555.png)

å…·ä½“æ¨ç†è¿‡ç¨‹è§ï¼šåŒçº¿æ€§æ’å€¼åŸç†

#### Deformable RoI Poolingb
æ‰€æœ‰åŸºäºåŒºåŸŸæè®®ï¼ˆRPNï¼‰çš„å¯¹è±¡æ£€æµ‹æ–¹æ³•éƒ½ä½¿ç”¨RoIæ± è¯å¤„ç†ï¼Œå°†ä»»æ„å¤§å°çš„è¾“å…¥çŸ©å½¢åŒºåŸŸè½¬æ¢ä¸ºå›ºå®šå¤§å°çš„ç‰¹å¾å›¾ã€‚

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/ecb969ec7b9b4fc08403dd005b4d40b9.png)

 ä¸€èˆ¬ä¸ºå°æ•°ï¼Œéœ€è¦ä½¿ç”¨åŒçº¿æ€§æ’å€¼è¿›è¡Œå¤„ç†ã€‚
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/beffd9b7e9164bf2a8780191f0d5163f.png)

å…·ä½“æ“ä½œå¦‚å›¾æ‰€ç¤ºï¼š

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/edce7c175c224e308f4e7ab3cd89cc1b.png)


å½“æ—¶çœ‹è¿™ä¸ªéƒ¨åˆ†çš„æ—¶å€™è§‰å¾—æœ‰äº›çªå…€ï¼Œæ˜æ˜RoIæ± åŒ–ä¼šå°†ç‰¹å¾å±‚è½¬åŒ–ä¸ºå›ºå®šå°ºå¯¸çš„åŒºåŸŸã€‚å…¶å®ï¼Œæˆ‘ä¸ªäººè§‰å¾—ï¼Œè¿™ä¸ªéƒ¨åˆ†ä¸ä¸Šè¿°çš„å¯å˜æ€§å·ç§¯æ“ä½œæ˜¯ç±»ä¼¼çš„ã€‚è¿™é‡ŒåŒæ ·æ˜¯ä½¿ç”¨äº†ä¸€ä¸ªæ™®é€šçš„RoIæ± åŒ–æ“ä½œï¼Œè¿›è¡Œä¸€äº›åˆ—å¤„ç†åå¾—åˆ°äº†ä¸€ä¸ªåç§»åŸŸç‰¹å¾å›¾ï¼Œç„¶åé‡æ–°ä½œç”¨äºåŸæ¥çš„w Ã— H w \times HwÃ—Hçš„RoIã€‚åªä¸è¿‡è¿™é‡Œä¸å†æ˜¯è§„å¾‹çš„é€è¡Œé€åˆ—å¯¹æ¯ä¸ªæ ¼å­è¿›è¡Œæ± åŒ–ï¼Œè€Œæ˜¯å¯¹äºæ ¼å­è¿›è¡Œåç§»åå†æ± åŒ–å¤„ç†ã€‚

#### Postionï¹£Sensitive RoI Pooling
é™¤æ­¤ä¹‹å¤–ï¼Œè®ºæ–‡è¿˜æå‡ºä¸€ç§PS RoIæ± åŒ–ï¼ˆPostionï¹£Sensitive RoI Poolingï¼‰ã€‚ä¸åŒäºä¸Šè¿°å¯å˜å½¢RoIæ± åŒ–ä¸­çš„å…¨è¿æ¥è¿‡ç¨‹ï¼Œè¿™é‡Œä½¿ç”¨å…¨å·ç§¯æ›¿æ¢ã€‚

å…·ä½“æ“ä½œå¦‚å›¾æ‰€ç¤ºï¼š
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/8fc3618147e24e69b84b65477a3c18b1.png)

é¦–å…ˆï¼Œå¯¹äºåŸæ¥çš„ç‰¹å¾å›¾æ¥è¯´ï¼ŒåŸæœ¬æ˜¯å°†è¾“å…¥ç‰¹å¾å›¾ä¸Šçš„RoIåŒºåŸŸåˆ†æˆk Ã— k k\times kkÃ—kä¸ªbinã€‚è€Œåœ¨è¿™é‡Œï¼Œåˆ™æ˜¯å°†è¾“å…¥ç‰¹å¾å›¾è¿›è¡Œå·ç§¯æ“ä½œï¼Œåˆ†åˆ«å¾—åˆ°ä¸€ä¸ªchannelsä¸ºk 2 ( C + 1 ) k^{2}(C+1)k (C+1)çš„å¾—åˆ†å›¾ï¼ˆscore mapsï¼‰å’Œä¸€ä¸ªchannelsä¸º2 k 2 ( C + 1 ) 2k{2}(C+1)2k 2 (C+1)çš„åç§»åŸŸï¼ˆoffset fieldsï¼‰ï¼Œè¿™ä¸¤ä¸ªç‰¹å¾çŸ©é˜µçš„å®½é«˜æ˜¯ä¸è¾“å…¥ç‰¹å¾çŸ©é˜µç›¸åŒçš„ã€‚å…¶ä¸­ï¼Œå¾—åˆ†å›¾çš„channelsä¸­ï¼Œk Ã— k k \times kkÃ—kåˆ†åˆ«è¡¨ç¤ºçš„æ˜¯æ¯ä¸€ä¸ªç½‘æ ¼ï¼ŒC CCè¡¨ç¤ºçš„æ£€æµ‹å¯¹è±¡çš„ç±»åˆ«æ•°ç›®ï¼Œ1è¡¨ç¤ºèƒŒæ™¯ã€‚è€Œåœ¨åç§»åŸŸä¸­çš„2è¡¨ç¤ºxyä¸¤ä¸ªæ–¹å‘çš„åç§»ã€‚
ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨PS RoIæ± åŒ–ä¸­ï¼Œå¯¹äºRoIçš„æ¯ä¸€ä¸ªç½‘æ ¼éƒ½ç‹¬è‡ªå ä¸€ä¸ªé€šé“å½¢æˆä¸€å±‚å¾—åˆ†å›¾ï¼Œç„¶åå…¶å¯¹äºçš„åç§»é‡å ä¸¤ä¸ªé€šé“ã€‚offset fieldså¾—åˆ°çš„åç§»æ˜¯å½’ä¸€åŒ–åçš„åç§»ï¼Œéœ€è¦é€šè¿‡å’Œdeformable RoI poolingä¸­ä¸€æ ·çš„å˜æ¢æ–¹å¼å¾—åˆ°âˆ† p i j âˆ†p_{ij}âˆ†p ijï¼Œç„¶åå¯¹æ¯å±‚å¾—åˆ†å›¾è¿›è¡Œåç§»æ± åŒ–å¤„ç†ã€‚æœ€åå¤„ç†å®Œçš„ç»“æœå°±å¯¹åº”ç€æœ€åè¾“å‡ºçš„ä¸€ä¸ªç½‘æ ¼ã€‚æ‰€ä»¥å…¶åŒ…å«äº†ä½ç½®ä¿¡æ¯ã€‚

åŸæ–‡è®ºè¿°ä¸ºï¼š


#### Understanding Deformable ConvNets
å½“å¯å˜å½¢å·ç§¯å åŠ æ—¶ï¼Œå¤åˆå˜å½¢çš„æ•ˆæœæ˜¯æ·±è¿œçš„ã€‚å¦‚å›¾æ‰€ç¤ºï¼š
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/245b1c99722548e6b493b4e7337629dc.png)

psï¼šaæ˜¯æ ‡å‡†å·ç§¯çš„å›ºå®šæ„Ÿå—é‡ï¼Œbæ˜¯å¯å˜å½¢å·ç§¯çš„é€‚åº”æ€§æ„Ÿå—é‡ã€‚

æ„Ÿå—é‡å’Œæ ‡å‡†å·ç§¯ä¸­çš„é‡‡æ ·ä½ç½®åœ¨æ•´ä¸ªé¡¶éƒ¨ç‰¹å¾å›¾ä¸Šæ˜¯å›ºå®šçš„(å·¦)ã€‚åœ¨å¯å˜å½¢å·ç§¯ä¸­ï¼Œå®ƒä»¬æ ¹æ®å¯¹è±¡çš„æ¯”ä¾‹å’Œå½¢çŠ¶è¿›è¡Œè‡ªé€‚åº”è°ƒæ•´(å³)ã€‚
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/eea4ed8068e84ccf8cdba4edcacd0889.png)



### 9.ç³»ç»ŸåŠŸèƒ½å±•ç¤º

å›¾9.1.ç³»ç»Ÿæ”¯æŒæ£€æµ‹ç»“æœè¡¨æ ¼æ˜¾ç¤º

  å›¾9.2.ç³»ç»Ÿæ”¯æŒç½®ä¿¡åº¦å’ŒIOUé˜ˆå€¼æ‰‹åŠ¨è°ƒèŠ‚

  å›¾9.3.ç³»ç»Ÿæ”¯æŒè‡ªå®šä¹‰åŠ è½½æƒé‡æ–‡ä»¶best.pt(éœ€è¦ä½ é€šè¿‡æ­¥éª¤5ä¸­è®­ç»ƒè·å¾—)

  å›¾9.4.ç³»ç»Ÿæ”¯æŒæ‘„åƒå¤´å®æ—¶è¯†åˆ«

  å›¾9.5.ç³»ç»Ÿæ”¯æŒå›¾ç‰‡è¯†åˆ«

  å›¾9.6.ç³»ç»Ÿæ”¯æŒè§†é¢‘è¯†åˆ«

  å›¾9.7.ç³»ç»Ÿæ”¯æŒè¯†åˆ«ç»“æœæ–‡ä»¶è‡ªåŠ¨ä¿å­˜

  å›¾9.8.ç³»ç»Ÿæ”¯æŒExcelå¯¼å‡ºæ£€æµ‹ç»“æœæ•°æ®

![10.png](10.png)

![11.png](11.png)

![12.png](12.png)

![13.png](13.png)

![14.png](14.png)

![15.png](15.png)

![16.png](16.png)

![17.png](17.png)

### 10. YOLOv11æ ¸å¿ƒæ”¹è¿›æºç è®²è§£

#### 10.1 starnet.py

ä»¥ä¸‹æ˜¯å¯¹ç»™å®šä»£ç çš„æ ¸å¿ƒéƒ¨åˆ†è¿›è¡Œåˆ†æå’Œè¯¦ç»†æ³¨é‡Šçš„ç»“æœï¼š

```python
import torch
import torch.nn as nn
from timm.models.layers import DropPath, trunc_normal_

# å®šä¹‰æ¨¡å‹çš„åç§°
__all__ = ['starnet_s050', 'starnet_s100', 'starnet_s150', 'starnet_s1', 'starnet_s2', 'starnet_s3', 'starnet_s4']

# é¢„è®­ç»ƒæ¨¡å‹çš„URL
model_urls = {
    "starnet_s1": "https://github.com/ma-xu/Rewrite-the-Stars/releases/download/checkpoints_v1/starnet_s1.pth.tar",
    "starnet_s2": "https://github.com/ma-xu/Rewrite-the-Stars/releases/download/checkpoints_v1/starnet_s2.pth.tar",
    "starnet_s3": "https://github.com/ma-xu/Rewrite-the-Stars/releases/download/checkpoints_v1/starnet_s3.pth.tar",
    "starnet_s4": "https://github.com/ma-xu/Rewrite-the-Stars/releases/download/checkpoints_v1/starnet_s4.pth.tar",
}

# å®šä¹‰å·ç§¯å±‚å’Œæ‰¹å½’ä¸€åŒ–çš„ç»„åˆ
class ConvBN(torch.nn.Sequential):
    def __init__(self, in_planes, out_planes, kernel_size=1, stride=1, padding=0, dilation=1, groups=1, with_bn=True):
        super().__init__()
        # æ·»åŠ å·ç§¯å±‚
        self.add_module('conv', torch.nn.Conv2d(in_planes, out_planes, kernel_size, stride, padding, dilation, groups))
        # å¦‚æœéœ€è¦ï¼Œæ·»åŠ æ‰¹å½’ä¸€åŒ–å±‚
        if with_bn:
            self.add_module('bn', torch.nn.BatchNorm2d(out_planes))
            # åˆå§‹åŒ–æ‰¹å½’ä¸€åŒ–çš„æƒé‡å’Œåç½®
            torch.nn.init.constant_(self.bn.weight, 1)
            torch.nn.init.constant_(self.bn.bias, 0)

# å®šä¹‰ç½‘ç»œçš„åŸºæœ¬æ¨¡å—
class Block(nn.Module):
    def __init__(self, dim, mlp_ratio=3, drop_path=0.):
        super().__init__()
        # æ·±åº¦å¯åˆ†ç¦»å·ç§¯
        self.dwconv = ConvBN(dim, dim, 7, 1, (7 - 1) // 2, groups=dim, with_bn=True)
        # çº¿æ€§å˜æ¢
        self.f1 = ConvBN(dim, mlp_ratio * dim, 1, with_bn=False)
        self.f2 = ConvBN(dim, mlp_ratio * dim, 1, with_bn=False)
        self.g = ConvBN(mlp_ratio * dim, dim, 1, with_bn=True)
        self.dwconv2 = ConvBN(dim, dim, 7, 1, (7 - 1) // 2, groups=dim, with_bn=False)
        self.act = nn.ReLU6()  # æ¿€æ´»å‡½æ•°
        self.drop_path = DropPath(drop_path) if drop_path > 0. else nn.Identity()  # éšæœºæ·±åº¦

    def forward(self, x):
        input = x  # ä¿å­˜è¾“å…¥
        x = self.dwconv(x)  # æ·±åº¦å¯åˆ†ç¦»å·ç§¯
        x1, x2 = self.f1(x), self.f2(x)  # çº¿æ€§å˜æ¢
        x = self.act(x1) * x2  # å…ƒç´ çº§ä¹˜æ³•
        x = self.dwconv2(self.g(x))  # ç»è¿‡å¦ä¸€ä¸ªå·ç§¯å±‚
        x = input + self.drop_path(x)  # æ®‹å·®è¿æ¥
        return x

# å®šä¹‰StarNetæ¨¡å‹
class StarNet(nn.Module):
    def __init__(self, base_dim=32, depths=[3, 3, 12, 5], mlp_ratio=4, drop_path_rate=0.0, num_classes=1000, **kwargs):
        super().__init__()
        self.num_classes = num_classes
        self.in_channel = 32
        # stemå±‚
        self.stem = nn.Sequential(ConvBN(3, self.in_channel, kernel_size=3, stride=2, padding=1), nn.ReLU6())
        dpr = [x.item() for x in torch.linspace(0, drop_path_rate, sum(depths))]  # éšæœºæ·±åº¦
        # æ„å»ºå„ä¸ªé˜¶æ®µ
        self.stages = nn.ModuleList()
        cur = 0
        for i_layer in range(len(depths)):
            embed_dim = base_dim * 2 ** i_layer  # å½“å‰å±‚çš„åµŒå…¥ç»´åº¦
            down_sampler = ConvBN(self.in_channel, embed_dim, 3, 2, 1)  # ä¸‹é‡‡æ ·
            self.in_channel = embed_dim
            blocks = [Block(self.in_channel, mlp_ratio, dpr[cur + i]) for i in range(depths[i_layer])]  # ç”ŸæˆBlock
            cur += depths[i_layer]
            self.stages.append(nn.Sequential(down_sampler, *blocks))  # æ·»åŠ åˆ°é˜¶æ®µä¸­
        
        self.channel = [i.size(1) for i in self.forward(torch.randn(1, 3, 640, 640))]  # è·å–é€šé“æ•°
        self.apply(self._init_weights)  # åˆå§‹åŒ–æƒé‡

    def _init_weights(self, m):
        # æƒé‡åˆå§‹åŒ–
        if isinstance(m, (nn.Linear, nn.Conv2d)):
            trunc_normal_(m.weight, std=.02)  # æˆªæ–­æ­£æ€åˆ†å¸ƒåˆå§‹åŒ–
            if isinstance(m, nn.Linear) and m.bias is not None:
                nn.init.constant_(m.bias, 0)  # åç½®åˆå§‹åŒ–ä¸º0
        elif isinstance(m, (nn.LayerNorm, nn.BatchNorm2d)):
            nn.init.constant_(m.bias, 0)  # åç½®åˆå§‹åŒ–ä¸º0
            nn.init.constant_(m.weight, 1.0)  # æƒé‡åˆå§‹åŒ–ä¸º1.0

    def forward(self, x):
        features = []  # ç‰¹å¾åˆ—è¡¨
        x = self.stem(x)  # ç»è¿‡stemå±‚
        features.append(x)  # ä¿å­˜ç‰¹å¾
        for stage in self.stages:
            x = stage(x)  # ç»è¿‡æ¯ä¸ªé˜¶æ®µ
            features.append(x)  # ä¿å­˜ç‰¹å¾
        return features  # è¿”å›æ‰€æœ‰ç‰¹å¾

# å®šä¹‰ä¸åŒè§„æ¨¡çš„StarNetæ¨¡å‹
def starnet_s1(pretrained=False, **kwargs):
    model = StarNet(24, [2, 2, 8, 3], **kwargs)  # å®šä¹‰æ¨¡å‹
    if pretrained:
        url = model_urls['starnet_s1']
        checkpoint = torch.hub.load_state_dict_from_url(url=url, map_location="cpu")  # åŠ è½½é¢„è®­ç»ƒæ¨¡å‹
        model.load_state_dict(checkpoint["state_dict"], strict=False)  # åŠ è½½æƒé‡
    return model

def starnet_s2(pretrained=False, **kwargs):
    model = StarNet(32, [1, 2, 6, 2], **kwargs)
    if pretrained:
        url = model_urls['starnet_s2']
        checkpoint = torch.hub.load_state_dict_from_url(url=url, map_location="cpu")
        model.load_state_dict(checkpoint["state_dict"], strict=False)
    return model

def starnet_s3(pretrained=False, **kwargs):
    model = StarNet(32, [2, 2, 8, 4], **kwargs)
    if pretrained:
        url = model_urls['starnet_s3']
        checkpoint = torch.hub.load_state_dict_from_url(url=url, map_location="cpu")
        model.load_state_dict(checkpoint["state_dict"], strict=False)
    return model

def starnet_s4(pretrained=False, **kwargs):
    model = StarNet(32, [3, 3, 12, 5], **kwargs)
    if pretrained:
        url = model_urls['starnet_s4']
        checkpoint = torch.hub.load_state_dict_from_url(url=url, map_location="cpu")
        model.load_state_dict(checkpoint["state_dict"], strict=False)
    return model

# å®šä¹‰éå¸¸å°çš„ç½‘ç»œ
def starnet_s050(pretrained=False, **kwargs):
    return StarNet(16, [1, 1, 3, 1], 3, **kwargs)

def starnet_s100(pretrained=False, **kwargs):
    return StarNet(20, [1, 2, 4, 1], 4, **kwargs)

def starnet_s150(pretrained=False, **kwargs):
    return StarNet(24, [1, 2, 4, 2], 3, **kwargs)
```

### ä»£ç æ ¸å¿ƒéƒ¨åˆ†åˆ†æï¼š
1. **ConvBNç±»**ï¼šè¯¥ç±»å°è£…äº†å·ç§¯å±‚å’Œæ‰¹å½’ä¸€åŒ–å±‚ï¼Œæä¾›äº†ä¸€ä¸ªç®€æ´çš„æ¥å£æ¥åˆ›å»ºå¸¦æœ‰æ‰¹å½’ä¸€åŒ–çš„å·ç§¯å±‚ã€‚
2. **Blockç±»**ï¼šå®ç°äº†StarNetçš„åŸºæœ¬æ„å»ºå—ï¼ŒåŒ…å«æ·±åº¦å¯åˆ†ç¦»å·ç§¯ã€çº¿æ€§å˜æ¢å’Œå…ƒç´ çº§ä¹˜æ³•ï¼Œå…·æœ‰æ®‹å·®è¿æ¥å’Œéšæœºæ·±åº¦åŠŸèƒ½ã€‚
3. **StarNetç±»**ï¼šæ•´ä¸ªç½‘ç»œçš„ä¸»ç±»ï¼Œè´Ÿè´£æ„å»ºç½‘ç»œçš„å„ä¸ªé˜¶æ®µï¼Œåˆå§‹åŒ–æƒé‡ï¼Œå¹¶å®šä¹‰å‰å‘ä¼ æ’­é€»è¾‘ã€‚
4. **æ¨¡å‹æ„å»ºå‡½æ•°**ï¼šå¦‚`starnet_s1`ç­‰å‡½æ•°ç”¨äºåˆ›å»ºä¸åŒè§„æ¨¡çš„StarNetæ¨¡å‹ï¼Œå¹¶æ”¯æŒåŠ è½½é¢„è®­ç»ƒæƒé‡ã€‚

è¿™äº›æ ¸å¿ƒéƒ¨åˆ†å…±åŒæ„æˆäº†StarNetçš„åŸºç¡€æ¶æ„ï¼Œå±•ç¤ºäº†å…¶åœ¨æ·±åº¦å­¦ä¹ ä¸­çš„åº”ç”¨ã€‚

è¿™ä¸ªç¨‹åºæ–‡ä»¶å®ç°äº†ä¸€ä¸ªåä¸ºStarNetçš„ç¥ç»ç½‘ç»œæ¨¡å‹ï¼Œä¸»è¦ç”¨äºå›¾åƒå¤„ç†ä»»åŠ¡ã€‚æ–‡ä»¶å¼€å¤´çš„æ–‡æ¡£å­—ç¬¦ä¸²è¯´æ˜äº†è¯¥æ¨¡å‹çš„è®¾è®¡ç†å¿µï¼Œå¼ºè°ƒäº†ç®€åŒ–ç½‘ç»œç»“æ„ä»¥çªå‡ºå…ƒç´ çº§ä¹˜æ³•çš„å…³é”®è´¡çŒ®ã€‚æ–‡ä»¶çš„åˆ›å»ºè€…æ˜¯Xu Maï¼Œå¹¶æä¾›äº†è”ç³»é‚®ç®±å’Œä¿®æ”¹æ—¥æœŸã€‚

åœ¨ä»£ç ä¸­ï¼Œé¦–å…ˆå¯¼å…¥äº†å¿…è¦çš„åº“ï¼ŒåŒ…æ‹¬PyTorchå’Œä¸€äº›ç”¨äºæ„å»ºæ¨¡å‹çš„å±‚ã€‚æ¥ç€å®šä¹‰äº†ä¸€ä¸ªåŒ…å«å¤šä¸ªæ¨¡å‹ç‰ˆæœ¬çš„åˆ—è¡¨ï¼Œè¿™äº›æ¨¡å‹çš„æƒé‡å¯ä»¥é€šè¿‡ç»™å®šçš„URLä¸‹è½½ã€‚

ConvBNç±»æ˜¯ä¸€ä¸ªç®€å•çš„å·ç§¯å±‚å’Œæ‰¹å½’ä¸€åŒ–å±‚çš„ç»„åˆã€‚å®ƒçš„æ„é€ å‡½æ•°æ¥å—å¤šä¸ªå‚æ•°ä»¥é…ç½®å·ç§¯æ“ä½œï¼Œå¹¶åœ¨éœ€è¦æ—¶æ·»åŠ æ‰¹å½’ä¸€åŒ–å±‚ã€‚è¯¥ç±»è¿˜åˆå§‹åŒ–äº†æ‰¹å½’ä¸€åŒ–å±‚çš„æƒé‡å’Œåç½®ã€‚

Blockç±»å®šä¹‰äº†StarNetä¸­çš„åŸºæœ¬æ„å»ºå—ã€‚æ¯ä¸ªBlockåŒ…å«ä¸€ä¸ªæ·±åº¦å·ç§¯å±‚ã€ä¸¤ä¸ª1x1å·ç§¯å±‚å’Œä¸€ä¸ªç”¨äºç‰¹å¾èåˆçš„æ¿€æ´»å‡½æ•°ã€‚å®ƒä½¿ç”¨ReLU6ä½œä¸ºæ¿€æ´»å‡½æ•°ï¼Œå¹¶åœ¨å‰å‘ä¼ æ’­ä¸­å®ç°äº†è¾“å…¥çš„è·³è·ƒè¿æ¥ã€‚

StarNetç±»æ˜¯æ•´ä¸ªç½‘ç»œçš„ä¸»ä½“ï¼Œæ„é€ å‡½æ•°ä¸­å®šä¹‰äº†ç½‘ç»œçš„åŸºæœ¬ç»“æ„ï¼ŒåŒ…æ‹¬è¾“å…¥é€šé“ã€stemå±‚å’Œå¤šä¸ªé˜¶æ®µã€‚æ¯ä¸ªé˜¶æ®µç”±ä¸‹é‡‡æ ·å±‚å’Œå¤šä¸ªBlockç»„æˆã€‚ç½‘ç»œçš„æ·±åº¦å’Œå®½åº¦å¯ä»¥é€šè¿‡å‚æ•°è¿›è¡Œè°ƒæ•´ï¼Œæ”¯æŒä¸åŒçš„æ¨¡å‹é…ç½®ã€‚

_init_weightsæ–¹æ³•ç”¨äºåˆå§‹åŒ–ç½‘ç»œä¸­å„å±‚çš„æƒé‡ï¼Œé‡‡ç”¨äº†æˆªæ–­æ­£æ€åˆ†å¸ƒçš„æ–¹æ³•ï¼Œä»¥ç¡®ä¿æ¨¡å‹åœ¨è®­ç»ƒå¼€å§‹æ—¶å…·æœ‰è‰¯å¥½çš„æ€§èƒ½ã€‚

StarNetçš„å‰å‘ä¼ æ’­æ–¹æ³•è¿”å›äº†å¤šä¸ªç‰¹å¾å›¾ï¼Œè¿™äº›ç‰¹å¾å›¾å¯ä»¥ç”¨äºåç»­çš„åˆ†ç±»æˆ–å…¶ä»–ä»»åŠ¡ã€‚

æœ€åï¼Œæ–‡ä»¶ä¸­å®šä¹‰äº†å¤šä¸ªå‡½æ•°ï¼Œç”¨äºåˆ›å»ºä¸åŒé…ç½®çš„StarNetæ¨¡å‹ï¼ˆå¦‚starnet_s1åˆ°starnet_s4ï¼‰ï¼Œå¹¶æ”¯æŒåŠ è½½é¢„è®­ç»ƒæƒé‡ã€‚è¿™äº›å‡½æ•°å…è®¸ç”¨æˆ·æ ¹æ®éœ€è¦é€‰æ‹©åˆé€‚çš„æ¨¡å‹è§„æ¨¡å’Œç»“æ„ã€‚

æ€»çš„æ¥è¯´ï¼Œè¿™ä¸ªæ–‡ä»¶æä¾›äº†ä¸€ä¸ªçµæ´»ä¸”å¯æ‰©å±•çš„ç¥ç»ç½‘ç»œæ¡†æ¶ï¼Œé€‚ç”¨äºå„ç§å›¾åƒå¤„ç†ä»»åŠ¡ï¼Œå¹¶ä¸”é€šè¿‡ç®€åŒ–è®¾è®¡çªå‡ºäº†æ¨¡å‹çš„æ ¸å¿ƒæ€æƒ³ã€‚

#### 10.2 val.py

ä»¥ä¸‹æ˜¯ä»£ç ä¸­æœ€æ ¸å¿ƒçš„éƒ¨åˆ†ï¼Œå¹¶é™„ä¸Šè¯¦ç»†çš„ä¸­æ–‡æ³¨é‡Šï¼š

```python
class DetectionValidator(BaseValidator):
    """
    DetectionValidatorç±»ï¼Œç»§æ‰¿è‡ªBaseValidatorç±»ï¼Œç”¨äºåŸºäºæ£€æµ‹æ¨¡å‹çš„éªŒè¯ã€‚
    """

    def __init__(self, dataloader=None, save_dir=None, pbar=None, args=None, _callbacks=None):
        """åˆå§‹åŒ–æ£€æµ‹æ¨¡å‹ï¼Œè®¾ç½®å¿…è¦çš„å˜é‡å’Œé…ç½®ã€‚"""
        super().__init__(dataloader, save_dir, pbar, args, _callbacks)
        self.nt_per_class = None  # æ¯ä¸ªç±»åˆ«çš„ç›®æ ‡æ•°é‡
        self.is_coco = False  # æ˜¯å¦ä¸ºCOCOæ•°æ®é›†
        self.class_map = None  # ç±»åˆ«æ˜ å°„
        self.args.task = "detect"  # è®¾ç½®ä»»åŠ¡ä¸ºæ£€æµ‹
        self.metrics = DetMetrics(save_dir=self.save_dir, on_plot=self.on_plot)  # åˆå§‹åŒ–æ£€æµ‹æŒ‡æ ‡
        self.iouv = torch.linspace(0.5, 0.95, 10)  # mAP@0.5:0.95çš„IoUå‘é‡
        self.niou = self.iouv.numel()  # IoUçš„æ•°é‡
        self.lb = []  # ç”¨äºè‡ªåŠ¨æ ‡è®°

    def preprocess(self, batch):
        """å¯¹YOLOè®­ç»ƒçš„å›¾åƒæ‰¹æ¬¡è¿›è¡Œé¢„å¤„ç†ã€‚"""
        # å°†å›¾åƒæ•°æ®ç§»åŠ¨åˆ°æŒ‡å®šè®¾å¤‡å¹¶è¿›è¡Œå½’ä¸€åŒ–å¤„ç†
        batch["img"] = batch["img"].to(self.device, non_blocking=True)
        batch["img"] = (batch["img"].half() if self.args.half else batch["img"].float()) / 255
        for k in ["batch_idx", "cls", "bboxes"]:
            batch[k] = batch[k].to(self.device)

        # å¦‚æœéœ€è¦ä¿å­˜æ··åˆæ•°æ®ï¼Œè¿›è¡Œç›¸åº”å¤„ç†
        if self.args.save_hybrid:
            height, width = batch["img"].shape[2:]
            nb = len(batch["img"])
            bboxes = batch["bboxes"] * torch.tensor((width, height, width, height), device=self.device)
            self.lb = (
                [
                    torch.cat([batch["cls"][batch["batch_idx"] == i], bboxes[batch["batch_idx"] == i]], dim=-1)
                    for i in range(nb)
                ]
                if self.args.save_hybrid
                else []
            )  # ç”¨äºè‡ªåŠ¨æ ‡è®°

        return batch

    def postprocess(self, preds):
        """å¯¹é¢„æµ‹è¾“å‡ºåº”ç”¨éæå¤§å€¼æŠ‘åˆ¶ï¼ˆNMSï¼‰ã€‚"""
        return ops.non_max_suppression(
            preds,
            self.args.conf,
            self.args.iou,
            labels=self.lb,
            multi_label=True,
            agnostic=self.args.single_cls,
            max_det=self.args.max_det,
        )

    def update_metrics(self, preds, batch):
        """æ›´æ–°æŒ‡æ ‡ç»Ÿè®¡ä¿¡æ¯ã€‚"""
        for si, pred in enumerate(preds):
            self.seen += 1  # è®°å½•å·²å¤„ç†çš„å›¾åƒæ•°é‡
            npr = len(pred)  # å½“å‰é¢„æµ‹çš„æ•°é‡
            stat = dict(
                conf=torch.zeros(0, device=self.device),
                pred_cls=torch.zeros(0, device=self.device),
                tp=torch.zeros(npr, self.niou, dtype=torch.bool, device=self.device),
            )
            pbatch = self._prepare_batch(si, batch)  # å‡†å¤‡å½“å‰æ‰¹æ¬¡çš„æ ‡ç­¾
            cls, bbox = pbatch.pop("cls"), pbatch.pop("bbox")  # è·å–å½“å‰æ‰¹æ¬¡çš„ç±»åˆ«å’Œè¾¹ç•Œæ¡†
            nl = len(cls)  # å½“å‰æ‰¹æ¬¡çš„æ ‡ç­¾æ•°é‡
            stat["target_cls"] = cls  # è®°å½•ç›®æ ‡ç±»åˆ«

            if npr == 0:  # å¦‚æœæ²¡æœ‰é¢„æµ‹ç»“æœ
                if nl:
                    for k in self.stats.keys():
                        self.stats[k].append(stat[k])
                continue

            # å¤„ç†é¢„æµ‹ç»“æœ
            predn = self._prepare_pred(pred, pbatch)  # å‡†å¤‡é¢„æµ‹ç»“æœ
            stat["conf"] = predn[:, 4]  # ç½®ä¿¡åº¦
            stat["pred_cls"] = predn[:, 5]  # é¢„æµ‹ç±»åˆ«

            # è¯„ä¼°
            if nl:
                stat["tp"] = self._process_batch(predn, bbox, cls)  # è®¡ç®—çœŸé˜³æ€§
            for k in self.stats.keys():
                self.stats[k].append(stat[k])  # æ›´æ–°ç»Ÿè®¡ä¿¡æ¯

    def get_stats(self):
        """è¿”å›æŒ‡æ ‡ç»Ÿè®¡ä¿¡æ¯å’Œç»“æœå­—å…¸ã€‚"""
        stats = {k: torch.cat(v, 0).cpu().numpy() for k, v in self.stats.items()}  # è½¬æ¢ä¸ºnumpyæ•°ç»„
        if len(stats) and stats["tp"].any():
            self.metrics.process(**stats)  # å¤„ç†æŒ‡æ ‡
        self.nt_per_class = np.bincount(
            stats["target_cls"].astype(int), minlength=self.nc
        )  # è®¡ç®—æ¯ä¸ªç±»åˆ«çš„ç›®æ ‡æ•°é‡
        return self.metrics.results_dict  # è¿”å›ç»“æœå­—å…¸
```

### ä»£ç æ ¸å¿ƒéƒ¨åˆ†è§£é‡Šï¼š
1. **DetectionValidatorç±»**ï¼šç”¨äºå¤„ç†YOLOæ¨¡å‹çš„éªŒè¯è¿‡ç¨‹ï¼Œç»§æ‰¿è‡ª`BaseValidator`ã€‚
2. **åˆå§‹åŒ–æ–¹æ³•**ï¼šè®¾ç½®å¿…è¦çš„å˜é‡å’ŒæŒ‡æ ‡ï¼Œç¡®å®šä»»åŠ¡ç±»å‹ã€‚
3. **é¢„å¤„ç†æ–¹æ³•**ï¼šå¯¹è¾“å…¥å›¾åƒè¿›è¡Œå½’ä¸€åŒ–å’Œè®¾å¤‡è½¬æ¢ï¼Œå¹¶å¤„ç†è¾¹ç•Œæ¡†å’Œç±»åˆ«ä¿¡æ¯ã€‚
4. **åå¤„ç†æ–¹æ³•**ï¼šåº”ç”¨éæå¤§å€¼æŠ‘åˆ¶ï¼Œå‡å°‘å†—ä½™çš„æ£€æµ‹æ¡†ã€‚
5. **æ›´æ–°æŒ‡æ ‡æ–¹æ³•**ï¼šæ›´æ–°å½“å‰æ‰¹æ¬¡çš„é¢„æµ‹ç»“æœå’Œç»Ÿè®¡ä¿¡æ¯ï¼Œè®¡ç®—çœŸé˜³æ€§ç­‰ã€‚
6. **è·å–ç»Ÿè®¡ä¿¡æ¯æ–¹æ³•**ï¼šè¿”å›å¤„ç†åçš„ç»Ÿè®¡ä¿¡æ¯å’Œç»“æœï¼Œè®¡ç®—æ¯ä¸ªç±»åˆ«çš„ç›®æ ‡æ•°é‡ã€‚

ä»¥ä¸Šéƒ¨åˆ†æ˜¯å®ç°YOLOæ£€æµ‹æ¨¡å‹éªŒè¯çš„æ ¸å¿ƒé€»è¾‘ï¼Œè´Ÿè´£æ•°æ®å¤„ç†ã€æŒ‡æ ‡æ›´æ–°å’Œç»“æœç»Ÿè®¡ã€‚

è¿™ä¸ªç¨‹åºæ–‡ä»¶ `val.py` æ˜¯ä¸€ä¸ªç”¨äºéªŒè¯åŸºäº YOLOï¼ˆYou Only Look Onceï¼‰æ¨¡å‹çš„ç›®æ ‡æ£€æµ‹çš„ç±»ï¼Œåä¸º `DetectionValidator`ã€‚è¯¥ç±»ç»§æ‰¿è‡ª `BaseValidator`ï¼Œå¹¶å®ç°äº†ä¸€ç³»åˆ—æ–¹æ³•æ¥å¤„ç†éªŒè¯è¿‡ç¨‹ä¸­çš„æ•°æ®é¢„å¤„ç†ã€æŒ‡æ ‡è®¡ç®—å’Œç»“æœè¾“å‡ºã€‚

åœ¨åˆå§‹åŒ–æ–¹æ³•ä¸­ï¼Œç±»è®¾ç½®äº†ä¸€äº›å¿…è¦çš„å˜é‡å’Œå‚æ•°ï¼ŒåŒ…æ‹¬æ˜¯å¦ä½¿ç”¨ COCO æ•°æ®é›†ã€ç±»åˆ«æ˜ å°„ã€ä»»åŠ¡ç±»å‹ï¼ˆæ£€æµ‹ï¼‰ä»¥åŠç”¨äºè®¡ç®—æ£€æµ‹æŒ‡æ ‡çš„å¯¹è±¡ã€‚`self.metrics` ç”¨äºå­˜å‚¨æ£€æµ‹æ€§èƒ½çš„æŒ‡æ ‡ï¼Œ`self.iouv` åˆ™å®šä¹‰äº†ä¸€ä¸ª IoUï¼ˆIntersection over Unionï¼‰å‘é‡ï¼Œç”¨äºè®¡ç®— mAPï¼ˆmean Average Precisionï¼‰ã€‚

`preprocess` æ–¹æ³•è´Ÿè´£å¯¹è¾“å…¥çš„å›¾åƒæ‰¹æ¬¡è¿›è¡Œé¢„å¤„ç†ï¼ŒåŒ…æ‹¬å°†å›¾åƒè½¬æ¢ä¸ºé€‚åˆæ¨¡å‹è¾“å…¥çš„æ ¼å¼ï¼Œå¹¶å°†ç›®æ ‡æ¡†çš„åæ ‡è°ƒæ•´ä¸ºé€‚åˆåç»­å¤„ç†çš„æ ¼å¼ã€‚å¦‚æœè®¾ç½®äº† `save_hybrid`ï¼Œåˆ™ä¼šç”Ÿæˆç”¨äºè‡ªåŠ¨æ ‡æ³¨çš„æ ‡ç­¾ã€‚

`init_metrics` æ–¹æ³•åˆå§‹åŒ–è¯„ä¼°æŒ‡æ ‡ï¼ŒåŒ…æ‹¬æ£€æŸ¥æ•°æ®é›†è·¯å¾„æ˜¯å¦ä¸º COCO æ ¼å¼ï¼Œå¹¶æ ¹æ®æ¨¡å‹çš„ç±»åˆ«åç§°è®¾ç½®ç›¸å…³å‚æ•°ã€‚`get_desc` æ–¹æ³•è¿”å›ä¸€ä¸ªæ ¼å¼åŒ–çš„å­—ç¬¦ä¸²ï¼Œç”¨äºæè¿°æ¯ä¸ªç±»åˆ«çš„æŒ‡æ ‡ã€‚

åœ¨ `postprocess` æ–¹æ³•ä¸­ï¼Œåº”ç”¨éæå¤§å€¼æŠ‘åˆ¶ï¼ˆNMSï¼‰æ¥è¿‡æ»¤é¢„æµ‹ç»“æœï¼Œç¡®ä¿æ¯ä¸ªç›®æ ‡åªä¿ç•™ä¸€ä¸ªæœ€ä½³çš„è¾¹ç•Œæ¡†ã€‚`_prepare_batch` å’Œ `_prepare_pred` æ–¹æ³•åˆ™åˆ†åˆ«ç”¨äºå‡†å¤‡çœŸå®æ ‡ç­¾å’Œé¢„æµ‹ç»“æœï¼Œä»¥ä¾¿åç»­çš„è¯„ä¼°ã€‚

`update_metrics` æ–¹æ³•è´Ÿè´£æ›´æ–°æ£€æµ‹æŒ‡æ ‡ï¼Œå¤„ç†æ¯ä¸ªæ‰¹æ¬¡çš„é¢„æµ‹ç»“æœå’ŒçœŸå®æ ‡ç­¾ï¼Œè®¡ç®— TPï¼ˆTrue Positiveï¼‰ç­‰ç»Ÿè®¡ä¿¡æ¯ï¼Œå¹¶å°†ç»“æœä¿å­˜åˆ°æŒ‡å®šçš„æ–‡ä»¶ä¸­ã€‚

`finalize_metrics` æ–¹æ³•è®¾ç½®æœ€ç»ˆçš„æŒ‡æ ‡å€¼ï¼ŒåŒ…æ‹¬é€Ÿåº¦å’Œæ··æ·†çŸ©é˜µã€‚`get_stats` æ–¹æ³•è¿”å›æŒ‡æ ‡ç»Ÿè®¡ä¿¡æ¯å’Œç»“æœå­—å…¸ã€‚

`print_results` æ–¹æ³•æ‰“å°è®­ç»ƒæˆ–éªŒè¯é›†çš„æ¯ä¸ªç±»åˆ«çš„æŒ‡æ ‡ï¼ŒåŒ…æ‹¬å›¾åƒæ•°é‡ã€å®ä¾‹æ•°é‡å’Œå„ç±»æŒ‡æ ‡çš„å¹³å‡å€¼ã€‚å¦‚æœè®¾ç½®äº†ç»˜å›¾é€‰é¡¹ï¼Œè¿˜ä¼šç»˜åˆ¶æ··æ·†çŸ©é˜µã€‚

`_process_batch` æ–¹æ³•ç”¨äºè¿”å›æ­£ç¡®çš„é¢„æµ‹çŸ©é˜µï¼Œé€šè¿‡è®¡ç®— IoU æ¥åŒ¹é…é¢„æµ‹å’ŒçœŸå®æ ‡ç­¾ã€‚`build_dataset` å’Œ `get_dataloader` æ–¹æ³•ç”¨äºæ„å»ºæ•°æ®é›†å’Œæ•°æ®åŠ è½½å™¨ï¼Œæ”¯æŒä¸åŒçš„æ‰¹æ¬¡å¤§å°å’Œæ¨¡å¼ã€‚

`plot_val_samples` å’Œ `plot_predictions` æ–¹æ³•ç”¨äºå¯è§†åŒ–éªŒè¯æ ·æœ¬å’Œé¢„æµ‹ç»“æœï¼Œç”Ÿæˆå¸¦æœ‰è¾¹ç•Œæ¡†çš„å›¾åƒå¹¶ä¿å­˜ã€‚

`save_one_txt` æ–¹æ³•å°† YOLO æ£€æµ‹ç»“æœä¿å­˜ä¸ºæ–‡æœ¬æ–‡ä»¶ï¼Œ`pred_to_json` æ–¹æ³•å°†é¢„æµ‹ç»“æœåºåˆ—åŒ–ä¸º COCO JSON æ ¼å¼ã€‚`eval_json` æ–¹æ³•åˆ™ç”¨äºè¯„ä¼° JSON æ ¼å¼çš„ YOLO è¾“å‡ºï¼Œå¹¶è¿”å›æ€§èƒ½ç»Ÿè®¡ä¿¡æ¯ã€‚

æ•´ä½“æ¥çœ‹ï¼Œè¿™ä¸ªæ–‡ä»¶å®ç°äº†ä¸€ä¸ªå®Œæ•´çš„ç›®æ ‡æ£€æµ‹éªŒè¯æµç¨‹ï¼ŒåŒ…æ‹¬æ•°æ®å¤„ç†ã€æŒ‡æ ‡è®¡ç®—ã€ç»“æœè¾“å‡ºå’Œå¯è§†åŒ–ç­‰åŠŸèƒ½ï¼Œé€‚ç”¨äºä½¿ç”¨ YOLO æ¨¡å‹è¿›è¡Œç›®æ ‡æ£€æµ‹çš„ä»»åŠ¡ã€‚

#### 10.3 efficientViT.py

ä»¥ä¸‹æ˜¯ä»£ç ä¸­æœ€æ ¸å¿ƒçš„éƒ¨åˆ†ï¼Œå¹¶é™„ä¸Šè¯¦ç»†çš„ä¸­æ–‡æ³¨é‡Šï¼š

```python
import torch
import torch.nn as nn
import torch.nn.functional as F
from timm.models.layers import SqueezeExcite

# å®šä¹‰å·ç§¯å±‚å’Œæ‰¹å½’ä¸€åŒ–çš„ç»„åˆ
class Conv2d_BN(torch.nn.Sequential):
    def __init__(self, in_channels, out_channels, kernel_size=1, stride=1, padding=0, dilation=1, groups=1, bn_weight_init=1):
        super().__init__()
        # æ·»åŠ å·ç§¯å±‚
        self.add_module('c', torch.nn.Conv2d(in_channels, out_channels, kernel_size, stride, padding, dilation, groups, bias=False))
        # æ·»åŠ æ‰¹å½’ä¸€åŒ–å±‚
        self.add_module('bn', torch.nn.BatchNorm2d(out_channels))
        # åˆå§‹åŒ–æ‰¹å½’ä¸€åŒ–çš„æƒé‡
        torch.nn.init.constant_(self.bn.weight, bn_weight_init)
        torch.nn.init.constant_(self.bn.bias, 0)

    @torch.no_grad()
    def switch_to_deploy(self):
        # å°†è®­ç»ƒæ¨¡å¼çš„å·ç§¯å’Œæ‰¹å½’ä¸€åŒ–å±‚èåˆä¸ºä¸€ä¸ªå·ç§¯å±‚
        c, bn = self._modules.values()
        w = bn.weight / (bn.running_var + bn.eps)**0.5  # è®¡ç®—æ–°çš„æƒé‡
        w = c.weight * w[:, None, None, None]  # èåˆæƒé‡
        b = bn.bias - bn.running_mean * bn.weight / (bn.running_var + bn.eps)**0.5  # è®¡ç®—æ–°çš„åç½®
        # åˆ›å»ºæ–°çš„å·ç§¯å±‚
        m = torch.nn.Conv2d(w.size(1) * self.c.groups, w.size(0), w.shape[2:], stride=self.c.stride, padding=self.c.padding, dilation=self.c.dilation, groups=self.c.groups)
        m.weight.data.copy_(w)  # å¤åˆ¶æƒé‡
        m.bias.data.copy_(b)  # å¤åˆ¶åç½®
        return m

# å®šä¹‰EfficientViTçš„åŸºæœ¬æ¨¡å—
class EfficientViTBlock(torch.nn.Module):
    def __init__(self, embed_dim, key_dim, num_heads=8, window_resolution=7):
        super().__init__()
        # å®šä¹‰å·ç§¯å±‚å’Œå‰é¦ˆç½‘ç»œ
        self.dw0 = Residual(Conv2d_BN(embed_dim, embed_dim, 3, 1, 1, groups=embed_dim))
        self.ffn0 = Residual(FFN(embed_dim, int(embed_dim * 2)))
        self.mixer = Residual(LocalWindowAttention(embed_dim, key_dim, num_heads, window_resolution=window_resolution))
        self.dw1 = Residual(Conv2d_BN(embed_dim, embed_dim, 3, 1, 1, groups=embed_dim))
        self.ffn1 = Residual(FFN(embed_dim, int(embed_dim * 2)))

    def forward(self, x):
        # å‰å‘ä¼ æ’­
        return self.ffn1(self.dw1(self.mixer(self.ffn0(self.dw0(x)))))

# å®šä¹‰EfficientViTæ¨¡å‹
class EfficientViT(torch.nn.Module):
    def __init__(self, img_size=400, patch_size=16, embed_dim=[64, 128, 192], depth=[1, 2, 3], num_heads=[4, 4, 4], window_size=[7, 7, 7]):
        super().__init__()
        # å®šä¹‰å›¾åƒåµŒå…¥å±‚
        self.patch_embed = torch.nn.Sequential(
            Conv2d_BN(3, embed_dim[0] // 8, 3, 2, 1),
            nn.ReLU(),
            Conv2d_BN(embed_dim[0] // 8, embed_dim[0] // 4, 3, 2, 1),
            nn.ReLU(),
            Conv2d_BN(embed_dim[0] // 4, embed_dim[0] // 2, 3, 2, 1),
            nn.ReLU(),
            Conv2d_BN(embed_dim[0] // 2, embed_dim[0], 3, 1, 1)
        )

        # å®šä¹‰å¤šä¸ªEfficientViTBlock
        self.blocks = []
        for i in range(len(depth)):
            for _ in range(depth[i]):
                self.blocks.append(EfficientViTBlock(embed_dim[i], key_dim=16, num_heads=num_heads[i], window_resolution=window_size[i]))
        self.blocks = torch.nn.Sequential(*self.blocks)

    def forward(self, x):
        # å‰å‘ä¼ æ’­
        x = self.patch_embed(x)  # å›¾åƒåµŒå…¥
        x = self.blocks(x)  # é€šè¿‡å¤šä¸ªEfficientViTBlock
        return x

# åˆ›å»ºEfficientViTæ¨¡å‹å®ä¾‹
if __name__ == '__main__':
    model = EfficientViT(img_size=224, patch_size=16)
    inputs = torch.randn((1, 3, 640, 640))  # éšæœºè¾“å…¥
    res = model(inputs)  # å‰å‘ä¼ æ’­
    print(res.size())  # è¾“å‡ºç»“æœçš„å°ºå¯¸
```

### ä»£ç æ³¨é‡Šè¯´æ˜ï¼š
1. **Conv2d_BNç±»**ï¼šè¯¥ç±»å°è£…äº†å·ç§¯å±‚å’Œæ‰¹å½’ä¸€åŒ–å±‚ï¼Œå¹¶æä¾›äº†ä¸€ä¸ªæ–¹æ³•æ¥å°†å…¶èåˆä¸ºä¸€ä¸ªå·ç§¯å±‚ï¼Œä»¥æé«˜æ¨ç†é€Ÿåº¦ã€‚
2. **EfficientViTBlockç±»**ï¼šè¿™æ˜¯EfficientViTçš„åŸºæœ¬æ„å»ºå—ï¼ŒåŒ…å«äº†å·ç§¯å±‚ã€å‰é¦ˆç½‘ç»œå’Œå±€éƒ¨çª—å£æ³¨æ„åŠ›æœºåˆ¶ã€‚
3. **EfficientViTç±»**ï¼šå®šä¹‰äº†æ•´ä¸ªEfficientViTæ¨¡å‹ï¼ŒåŒ…æ‹¬å›¾åƒåµŒå…¥å±‚å’Œå¤šä¸ªEfficientViTBlockçš„å †å ã€‚
4. **å‰å‘ä¼ æ’­**ï¼šæ¨¡å‹çš„å‰å‘ä¼ æ’­è¿‡ç¨‹ï¼Œé¦–å…ˆå°†è¾“å…¥å›¾åƒåµŒå…¥ï¼Œç„¶åé€šè¿‡å¤šä¸ªå—è¿›è¡Œå¤„ç†ï¼Œæœ€ç»ˆè¾“å‡ºç‰¹å¾ã€‚

è¿™ä¸ªç¨‹åºæ–‡ä»¶å®ç°äº†ä¸€ä¸ªé«˜æ•ˆçš„è§†è§‰å˜æ¢å™¨ï¼ˆEfficientViTï¼‰æ¨¡å‹æ¶æ„ï¼Œé€‚ç”¨äºå„ç§ä¸‹æ¸¸ä»»åŠ¡ã€‚æ–‡ä»¶ä¸­åŒ…å«å¤šä¸ªç±»å’Œå‡½æ•°ï¼Œæ„æˆäº†æ¨¡å‹çš„æ•´ä½“ç»“æ„å’ŒåŠŸèƒ½ã€‚

é¦–å…ˆï¼Œæ–‡ä»¶å¼•å…¥äº†å¿…è¦çš„åº“ï¼ŒåŒ…æ‹¬PyTorchåŠå…¶ç›¸å…³æ¨¡å—ã€‚æ¥ç€å®šä¹‰äº†ä¸€ä¸ªåä¸º`Conv2d_BN`çš„ç±»ï¼Œè¯¥ç±»æ˜¯ä¸€ä¸ªåŒ…å«å·ç§¯å±‚å’Œæ‰¹å½’ä¸€åŒ–å±‚çš„é¡ºåºå®¹å™¨ã€‚è¿™ä¸ªç±»åœ¨åˆå§‹åŒ–æ—¶è®¾ç½®äº†å·ç§¯å±‚çš„å‚æ•°ï¼Œå¹¶å¯¹æ‰¹å½’ä¸€åŒ–å±‚çš„æƒé‡å’Œåç½®è¿›è¡Œäº†åˆå§‹åŒ–ã€‚å®ƒè¿˜æä¾›äº†ä¸€ä¸ª`switch_to_deploy`æ–¹æ³•ï¼Œç”¨äºåœ¨æ¨ç†é˜¶æ®µå°†æ‰¹å½’ä¸€åŒ–å±‚è½¬æ¢ä¸ºå·ç§¯å±‚ã€‚

æ¥ä¸‹æ¥ï¼Œ`replace_batchnorm`å‡½æ•°ç”¨äºéå†ç½‘ç»œä¸­çš„æ‰€æœ‰å­æ¨¡å—ï¼Œå°†æ‰¹å½’ä¸€åŒ–å±‚æ›¿æ¢ä¸ºæ’ç­‰æ˜ å°„ï¼Œä»¥ä¾¿åœ¨æ¨ç†æ—¶æé«˜æ•ˆç‡ã€‚

`PatchMerging`ç±»å®ç°äº†å¯¹è¾“å…¥ç‰¹å¾å›¾çš„åˆå¹¶æ“ä½œï¼Œä½¿ç”¨å¤šä¸ªå·ç§¯å±‚å’Œæ¿€æ´»å‡½æ•°æ¥å¤„ç†è¾“å…¥æ•°æ®ã€‚`Residual`ç±»åˆ™å®ç°äº†æ®‹å·®è¿æ¥çš„åŠŸèƒ½ï¼Œå¯ä»¥åœ¨è®­ç»ƒæ—¶éšæœºä¸¢å¼ƒéƒ¨åˆ†è¾“å…¥ï¼Œä»¥å¢å¼ºæ¨¡å‹çš„é²æ£’æ€§ã€‚

`FFN`ç±»å®ç°äº†å‰é¦ˆç¥ç»ç½‘ç»œï¼ŒåŒ…å«ä¸¤ä¸ªå·ç§¯å±‚å’Œä¸€ä¸ªReLUæ¿€æ´»å‡½æ•°ã€‚`CascadedGroupAttention`å’Œ`LocalWindowAttention`ç±»å®ç°äº†ä¸åŒç±»å‹çš„æ³¨æ„åŠ›æœºåˆ¶ï¼Œç”¨äºå¤„ç†è¾“å…¥ç‰¹å¾å›¾ä¸­çš„ä¿¡æ¯ã€‚å®ƒä»¬é€šè¿‡åˆ†ç»„å·ç§¯å’Œæ³¨æ„åŠ›æœºåˆ¶æ¥æå–ç‰¹å¾ã€‚

`EfficientViTBlock`ç±»æ˜¯é«˜æ•ˆè§†è§‰å˜æ¢å™¨çš„åŸºæœ¬æ„å»ºå—ï¼Œç»“åˆäº†å·ç§¯å±‚ã€å‰é¦ˆç½‘ç»œå’Œæ³¨æ„åŠ›æœºåˆ¶ã€‚`EfficientViT`ç±»åˆ™æ˜¯æ•´ä¸ªæ¨¡å‹çš„ä¸»ç±»ï¼Œè´Ÿè´£æ„å»ºæ¨¡å‹çš„ä¸åŒé˜¶æ®µï¼ŒåŒ…æ‹¬å›¾åƒåµŒå…¥ã€å¤šä¸ªEfficientViTå—çš„å †å ç­‰ã€‚

åœ¨æ¨¡å‹çš„åˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œç”¨æˆ·å¯ä»¥è®¾ç½®å›¾åƒå¤§å°ã€è¡¥ä¸å¤§å°ã€åµŒå…¥ç»´åº¦ã€æ·±åº¦ã€æ³¨æ„åŠ›å¤´æ•°ç­‰å‚æ•°ã€‚æ¨¡å‹çš„å‰å‘ä¼ æ’­æ–¹æ³•è¿”å›äº†å¤šä¸ªé˜¶æ®µçš„è¾“å‡ºï¼Œä¾¿äºä¸‹æ¸¸ä»»åŠ¡çš„ä½¿ç”¨ã€‚

æœ€åï¼Œæ–‡ä»¶å®šä¹‰äº†ä¸€äº›ä¸åŒé…ç½®çš„EfficientViTæ¨¡å‹ï¼ˆå¦‚`EfficientViT_m0`åˆ°`EfficientViT_m5`ï¼‰ï¼Œå¹¶æä¾›äº†ç›¸åº”çš„æ„å»ºå‡½æ•°ã€‚è¿™äº›å‡½æ•°å…è®¸ç”¨æˆ·åŠ è½½é¢„è®­ç»ƒæƒé‡ï¼Œå¹¶é€‰æ‹©æ˜¯å¦èåˆæ‰¹å½’ä¸€åŒ–å±‚ã€‚

åœ¨`__main__`éƒ¨åˆ†ï¼Œç¤ºä¾‹ä»£ç å±•ç¤ºäº†å¦‚ä½•å®ä¾‹åŒ–ä¸€ä¸ªEfficientViTæ¨¡å‹ï¼Œå¹¶å¯¹éšæœºè¾“å…¥è¿›è¡Œå‰å‘ä¼ æ’­ï¼Œè¾“å‡ºå„ä¸ªé˜¶æ®µçš„ç‰¹å¾å›¾å¤§å°ã€‚æ•´ä½“ä¸Šï¼Œè¿™ä¸ªæ–‡ä»¶å®ç°äº†ä¸€ä¸ªçµæ´»ä¸”é«˜æ•ˆçš„è§†è§‰å˜æ¢å™¨æ¶æ„ï¼Œé€‚ç”¨äºå¤šç§è®¡ç®—æœºè§†è§‰ä»»åŠ¡ã€‚

#### 10.4 cfpt.py

ä»¥ä¸‹æ˜¯ä¿ç•™çš„æ ¸å¿ƒä»£ç éƒ¨åˆ†ï¼Œå¹¶æ·»åŠ äº†è¯¦ç»†çš„ä¸­æ–‡æ³¨é‡Šï¼š

```python
import torch
import torch.nn as nn
import torch.nn.functional as F
from timm.layers import to_2tuple, trunc_normal_

class CrossLayerPosEmbedding3D(nn.Module):
    def __init__(self, num_heads=4, window_size=(5, 3, 1), spatial=True):
        super(CrossLayerPosEmbedding3D, self).__init__()
        self.spatial = spatial  # æ˜¯å¦ä½¿ç”¨ç©ºé—´ä½ç½®åµŒå…¥
        self.num_heads = num_heads  # æ³¨æ„åŠ›å¤´çš„æ•°é‡
        self.layer_num = len(window_size)  # å±‚æ•°
        # åˆå§‹åŒ–ç›¸å¯¹ä½ç½®åç½®è¡¨
        self.relative_position_bias_table = nn.Parameter(
            torch.zeros((2 * window_size[0] - 1) * (2 * window_size[0] - 1), num_heads))
        )
        # è®¡ç®—ç›¸å¯¹ä½ç½®ç´¢å¼•
        self.register_buffer("relative_position_index", self.calculate_relative_position_index(window_size))
        trunc_normal_(self.relative_position_bias_table, std=.02)  # åˆå§‹åŒ–ç›¸å¯¹ä½ç½®åç½®

        # åˆå§‹åŒ–ç»å¯¹ä½ç½®åç½®
        self.absolute_position_bias = nn.Parameter(torch.zeros(len(window_size), num_heads, 1, 1, 1))
        trunc_normal_(self.absolute_position_bias, std=.02)

    def calculate_relative_position_index(self, window_size):
        # è®¡ç®—ç›¸å¯¹ä½ç½®ç´¢å¼•
        coords_h = [torch.arange(ws) - ws // 2 for ws in window_size]
        coords_w = [torch.arange(ws) - ws // 2 for ws in window_size]
        coords = [torch.stack(torch.meshgrid([coord_h, coord_w])) for coord_h, coord_w in zip(coords_h, coords_w)]
        coords_flatten = torch.cat([torch.flatten(coord, 1) for coord in coords], dim=-1)
        relative_coords = coords_flatten[:, :, None] - coords_flatten[:, None, :]
        relative_coords = relative_coords.permute(1, 2, 0).contiguous()
        relative_coords[:, :, 0] += window_size[0] - 1
        relative_coords[:, :, 1] += window_size[0] - 1
        relative_coords[:, :, 0] *= 2 * window_size[0] - 1
        return relative_coords.sum(-1)

    def forward(self):
        # è®¡ç®—ä½ç½®åµŒå…¥
        pos_indicies = self.relative_position_index.view(-1)
        pos_indicies_floor = torch.floor(pos_indicies).long()
        pos_indicies_ceil = torch.ceil(pos_indicies).long()
        value_floor = self.relative_position_bias_table[pos_indicies_floor]
        value_ceil = self.relative_position_bias_table[pos_indicies_ceil]
        weights_ceil = pos_indicies - pos_indicies_floor.float()
        weights_floor = 1.0 - weights_ceil

        pos_embed = weights_floor.unsqueeze(-1) * value_floor + weights_ceil.unsqueeze(-1) * value_ceil
        pos_embed = pos_embed.reshape(1, 1, self.num_token, -1, self.num_heads).permute(0, 4, 1, 2, 3)

        return pos_embed + self.absolute_position_bias

class CrossLayerSpatialAttention(nn.Module):
    def __init__(self, in_dim, layer_num=3, num_heads=4):
        super(CrossLayerSpatialAttention, self).__init__()
        self.num_heads = num_heads  # æ³¨æ„åŠ›å¤´çš„æ•°é‡
        self.hidden_dim = in_dim // 4  # éšè—ç»´åº¦
        self.qkv = nn.Conv2d(in_dim, self.hidden_dim * 3, kernel_size=1)  # çº¿æ€§å˜æ¢
        self.softmax = nn.Softmax(dim=-1)  # softmaxå±‚
        self.pos_embed = CrossLayerPosEmbedding3D(num_heads=num_heads)  # ä½ç½®åµŒå…¥

    def forward(self, x_list):
        q_list, k_list, v_list = [], [], []

        for x in x_list:
            qkv = self.qkv(x)  # è®¡ç®—Q, K, V
            q, k, v = qkv.chunk(3, dim=1)  # åˆ†å‰²Q, K, V
            q_list.append(q)
            k_list.append(k)
            v_list.append(v)

        # å°†Q, K, Vå †å åœ¨ä¸€èµ·
        q_stack = torch.cat(q_list, dim=1)
        k_stack = torch.cat(k_list, dim=1)
        v_stack = torch.cat(v_list, dim=1)

        # è®¡ç®—æ³¨æ„åŠ›
        attn = F.normalize(q_stack, dim=-1) @ F.normalize(k_stack, dim=-1).transpose(-1, -2)
        attn = attn + self.pos_embed()  # åŠ å…¥ä½ç½®åµŒå…¥
        attn = self.softmax(attn)  # å½’ä¸€åŒ–

        out = attn @ v_stack  # è®¡ç®—è¾“å‡º
        return out  # è¿”å›è¾“å‡º
```

### ä»£ç æ ¸å¿ƒéƒ¨åˆ†è¯´æ˜ï¼š
1. **CrossLayerPosEmbedding3D**: è¯¥ç±»ç”¨äºè®¡ç®—è·¨å±‚çš„3Dä½ç½®åµŒå…¥ï¼ŒåŒ…æ‹¬ç›¸å¯¹ä½ç½®åç½®å’Œç»å¯¹ä½ç½®åç½®çš„åˆå§‹åŒ–å’Œè®¡ç®—ã€‚
2. **CrossLayerSpatialAttention**: è¯¥ç±»å®ç°äº†è·¨å±‚ç©ºé—´æ³¨æ„åŠ›æœºåˆ¶ï¼ŒåŒ…å«Qã€Kã€Vçš„è®¡ç®—å’Œæ³¨æ„åŠ›çš„è®¡ç®—é€»è¾‘ã€‚
3. **forwardæ–¹æ³•**: åœ¨è¿™ä¸¤ä¸ªç±»ä¸­ï¼Œ`forward`æ–¹æ³•å®šä¹‰äº†å¦‚ä½•å¤„ç†è¾“å…¥æ•°æ®å¹¶è®¡ç®—è¾“å‡ºã€‚å¯¹äº`CrossLayerSpatialAttention`ï¼Œå®ƒå°†è¾“å…¥åˆ†ä¸ºQã€Kã€Vï¼Œå¹¶è®¡ç®—æ³¨æ„åŠ›è¾“å‡ºã€‚

ä»¥ä¸Šä»£ç å±•ç¤ºäº†è·¨å±‚æ³¨æ„åŠ›æœºåˆ¶çš„æ ¸å¿ƒé€»è¾‘ï¼Œæ³¨é‡Šè¯¦ç»†è§£é‡Šäº†æ¯ä¸ªéƒ¨åˆ†çš„åŠŸèƒ½å’Œä½œç”¨ã€‚

è¿™ä¸ªç¨‹åºæ–‡ä»¶ `cfpt.py` å®ç°äº†ä¸¤ä¸ªä¸»è¦çš„ç¥ç»ç½‘ç»œæ¨¡å—ï¼š`CrossLayerChannelAttention` å’Œ `CrossLayerSpatialAttention`ï¼Œå®ƒä»¬éƒ½åŸºäºæ·±åº¦å­¦ä¹ æ¡†æ¶ PyTorchã€‚æ–‡ä»¶ä¸­è¿˜å®šä¹‰äº†ä¸€äº›è¾…åŠ©ç±»å’Œå‡½æ•°ï¼Œç”¨äºå®ç°ç‰¹å®šçš„åŠŸèƒ½ï¼Œå¦‚ä½ç½®ç¼–ç ã€å·ç§¯æ“ä½œå’Œçª—å£åˆ’åˆ†ç­‰ã€‚

é¦–å…ˆï¼Œæ–‡ä»¶å¯¼å…¥äº†å¿…è¦çš„åº“ï¼ŒåŒ…æ‹¬ PyTorchã€æ•°å­¦åº“ã€einopsï¼ˆç”¨äºå¼ é‡é‡æ’ï¼‰ã€ä»¥åŠä¸€äº› PyTorch çš„æ¨¡å—å’ŒåŠŸèƒ½ã€‚æ¥ç€ï¼Œå®šä¹‰äº†ä¸€ä¸ª `LayerNormProxy` ç±»ï¼Œè¯¥ç±»å°è£…äº† PyTorch çš„å±‚å½’ä¸€åŒ–åŠŸèƒ½ï¼Œå¹¶åœ¨å‰å‘ä¼ æ’­ä¸­è°ƒæ•´è¾“å…¥å¼ é‡çš„ç»´åº¦ã€‚

æ¥ä¸‹æ¥ï¼Œ`CrossLayerPosEmbedding3D` ç±»ç”¨äºç”Ÿæˆè·¨å±‚ä½ç½®åµŒå…¥ã€‚å®ƒæ ¹æ®ç»™å®šçš„çª—å£å¤§å°å’Œå¤´æ•°åˆå§‹åŒ–ç›¸å¯¹ä½ç½®åç½®è¡¨ï¼Œå¹¶è®¡ç®—ç›¸å¯¹ä½ç½®ç´¢å¼•ã€‚è¯¥ç±»çš„å‰å‘æ–¹æ³•ç”Ÿæˆä½ç½®åµŒå…¥ï¼Œç”¨äºåç»­çš„æ³¨æ„åŠ›è®¡ç®—ã€‚

`ConvPosEnc` ç±»å®ç°äº†å·ç§¯ä½ç½®ç¼–ç ï¼Œä½¿ç”¨æ·±åº¦å¯åˆ†ç¦»å·ç§¯æ¥å¢å¼ºç‰¹å¾å›¾ï¼Œå¹¶å¯é€‰æ‹©æ€§åœ°æ·»åŠ æ¿€æ´»å‡½æ•°ã€‚`DWConv` ç±»åˆ™å®ç°äº†æ·±åº¦å·ç§¯æ“ä½œï¼Œç”¨äºå¤„ç†è¾“å…¥ç‰¹å¾å›¾ã€‚

`Mlp` ç±»å®ç°äº†ä¸€ä¸ªç®€å•çš„å¤šå±‚æ„ŸçŸ¥æœºï¼ˆMLPï¼‰ï¼ŒåŒ…å«ä¸¤ä¸ªçº¿æ€§å±‚å’Œä¸€ä¸ªæ¿€æ´»å‡½æ•°ã€‚

æ¥ä¸‹æ¥çš„å‡ ä¸ªå‡½æ•°å®ç°äº†çª—å£åˆ’åˆ†å’Œé€†æ“ä½œï¼Œä¸»è¦ç”¨äºå¤„ç†è¾“å…¥ç‰¹å¾å›¾çš„é‡ç»„å’Œæ¢å¤ï¼Œæ”¯æŒé‡å çª—å£çš„å¤„ç†ã€‚

`CrossLayerSpatialAttention` ç±»å®ç°äº†ç©ºé—´æ³¨æ„åŠ›æœºåˆ¶ã€‚å®ƒé€šè¿‡å¤šå±‚å·ç§¯ã€å½’ä¸€åŒ–å’Œæ³¨æ„åŠ›è®¡ç®—æ¥å¤„ç†è¾“å…¥ç‰¹å¾å›¾ã€‚è¯¥ç±»çš„å‰å‘æ–¹æ³•æ¥æ”¶å¤šä¸ªè¾“å…¥ç‰¹å¾å›¾ï¼Œè®¡ç®—æŸ¥è¯¢ã€é”®ã€å€¼ï¼Œå¹¶é€šè¿‡æ³¨æ„åŠ›æœºåˆ¶ç”Ÿæˆè¾“å‡ºç‰¹å¾å›¾ã€‚å®ƒè¿˜ä½¿ç”¨äº†ä¹‹å‰å®šä¹‰çš„å·ç§¯ä½ç½®ç¼–ç å’Œä½ç½®åµŒå…¥ã€‚

`CrossLayerChannelAttention` ç±»å®ç°äº†é€šé“æ³¨æ„åŠ›æœºåˆ¶ï¼Œç»“æ„ä¸ç©ºé—´æ³¨æ„åŠ›ç±»ä¼¼ï¼Œä½†å¤„ç†æ–¹å¼ä¸åŒã€‚å®ƒä½¿ç”¨é€šé“åˆ’åˆ†å’Œé€†æ“ä½œæ¥å®ç°å¯¹è¾“å…¥ç‰¹å¾å›¾çš„å¤„ç†ã€‚è¯¥ç±»åŒæ ·åœ¨å‰å‘æ–¹æ³•ä¸­æ¥æ”¶å¤šä¸ªè¾“å…¥ç‰¹å¾å›¾ï¼Œè®¡ç®—æ³¨æ„åŠ›å¹¶ç”Ÿæˆè¾“å‡ºã€‚

æ•´ä½“æ¥çœ‹ï¼Œè¿™ä¸ªæ–‡ä»¶å®ç°äº†ä¸€ä¸ªå¤æ‚çš„æ³¨æ„åŠ›æœºåˆ¶ï¼Œæ—¨åœ¨æé«˜æ·±åº¦å­¦ä¹ æ¨¡å‹åœ¨å¤„ç†å›¾åƒæˆ–å…¶ä»–é«˜ç»´æ•°æ®æ—¶çš„æ€§èƒ½ã€‚é€šè¿‡è·¨å±‚çš„é€šé“å’Œç©ºé—´æ³¨æ„åŠ›ï¼Œæ¨¡å‹èƒ½å¤Ÿæ›´å¥½åœ°æ•æ‰ç‰¹å¾ä¹‹é—´çš„å…³ç³»ï¼Œä»è€Œæå‡ç‰¹å¾è¡¨ç¤ºçš„èƒ½åŠ›ã€‚

### 11.å®Œæ•´è®­ç»ƒ+Webå‰ç«¯ç•Œé¢+200+ç§å…¨å¥—åˆ›æ–°ç‚¹æºç ã€æ•°æ®é›†è·å–

![19.png](19.png)


# [ä¸‹è½½é“¾æ¥ï¼šhttps://mbd.pub/o/bread/Z5yblJZt](https://mbd.pub/o/bread/Z5yblJZt)